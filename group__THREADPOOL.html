<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>libfoedus-core: Thread-Pool and Impersonation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libfoedus-core
   </div>
   <div id="projectbrief">FOEDUS Core Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/centos7/"><span>Jenkins&#160;(x86_64&#160;Fedora)</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/ub1404/"><span>Jenkins&#160;(x86_64&#160;Ubuntu)</span></a></li>
      <li><a href="http://ms01915-003.hpl.hp.com:8080/"><span>Jenkins&#160;(aarch64&#160;Ubuntu)</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/tree/master"><span>Github</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/wiki"><span>Wiki</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__THREADPOOL.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a>  </div>
  <div class="headertitle">
<div class="title">Thread-Pool and Impersonation<div class="ingroups"><a class="el" href="group__COMPONENTS.html">FOEDUS Components</a> &raquo; <a class="el" href="group__THREAD.html">Thread and Thread-Group</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>APIs to <b>pool</b> and <b>impersonate</b> worker threads in libfoedus-core.  
<a href="#details">More...</a></p>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>APIs to <b>pool</b> and <b>impersonate</b> worker threads in libfoedus-core. </p>
<h1><a class="anchor" id="THR"></a>
Database Engine API and Thread</h1>
<p>You might have already noticed that most of our APIs provided by the database engine requires a <a class="el" href="classfoedus_1_1thread_1_1Thread.html" title="Represents one thread running on one NUMA core. ">Thread</a> object as its execution context. On the other hand, client programs aren't allowed to instantiate <a class="el" href="classfoedus_1_1thread_1_1Thread.html" title="Represents one thread running on one NUMA core. ">Thread</a> instances by themselves. So, you have to first obtain the <a class="el" href="classfoedus_1_1thread_1_1Thread.html" title="Represents one thread running on one NUMA core. ">Thread</a> object from the engine. This document describes how user programs do that, and why.</p>
<h1><a class="anchor" id="POOL"></a>
Thread Pool</h1>
<p>Most client program needs concurrent accesses running on multiple threads. In order to avoid overheads and complexity of launching and maintaining threads by such client programs, our engine provides a pool of pre-allocated threads. This also makes it easy for the engine to guarantee efficient mapping between thread and NUMA-core. As described in <a class="el" href="group__MEMHIERARCHY.html">Memory Hierarchy</a>, our engine ties threads to their private memories. If our engine lets the client program to manage its own threads, we can't achieve the static and efficient mapping.</p>
<dl class="section user"><dt>Number of thread/group configurations</dt><dd>Our engine pre-allocates a fixed number of <a class="el" href="classfoedus_1_1thread_1_1ThreadGroup.html" title="Represents a group of pre-allocated threads running in one NUMA node. ">ThreadGroup</a> and <a class="el" href="classfoedus_1_1thread_1_1Thread.html" title="Represents one thread running on one NUMA core. ">Thread</a> at start-up. You can configure the numbers in <a class="el" href="structfoedus_1_1thread_1_1ThreadOptions.html" title="Set of options about threads and thread-groups. ">ThreadOptions</a>, but in many cases the default values (which is the number of hardware NUMA nodes/cores) work fine.</dd></dl>
<h1><a class="anchor" id="IMPERSONATE"></a>
Impersonation</h1>
<p>Our API to execute transactions consists of the following three concepts: </p><ul>
<li><b>Procedure</b> (<a class="el" href="group__PROC.html">System and User Procedures</a>) is an arbitrary user-defined code to run in our engine. </li>
<li><b>Session</b> (<a class="el" href="structfoedus_1_1thread_1_1ImpersonateSession.html" title="A user session running on an impersonated thread. ">ImpersonateSession</a>) is a one-to-one mapping between a procedure and a pooled thread that continues until the completion of the procedure. </li>
<li><b>Impersonation</b> (<a class="el" href="classfoedus_1_1thread_1_1ThreadPool.html#a34531989c3885ab6e0cccc19bf53d87c" title="Impersonate as one of pre-allocated threads in this engine, executing the procedure on the impersonat...">ThreadPool::impersonate()</a>) is an action to create a session for the given procedure.</li>
</ul>
<p>In order to start a user transaction or a series of user transactions on some thread, the user first defines the procedure as a function as defined in <a class="el" href="group__PROC.html">System and User Procedures</a>. Then, the user calls <a class="el" href="classfoedus_1_1thread_1_1ThreadPool.html#a34531989c3885ab6e0cccc19bf53d87c" title="Impersonate as one of pre-allocated threads in this engine, executing the procedure on the impersonat...">ThreadPool::impersonate()</a> to impersonate one of the pre-allocated threads for the procedure.</p>
<p>When the thread is impersonated, it starts runninng the procedure asynchronously. The original client thread, which invoked the impersonation, immediately returns with <a class="el" href="structfoedus_1_1thread_1_1ImpersonateSession.html" title="A user session running on an impersonated thread. ">ImpersonateSession</a> object for the acquired session. The original thread can choose to either synchronously wait for the completion of the procedure or do other stuffs, such as launching more sessions (be it the same procedure or not).</p>
<p>This means that a use code doesn't have to do <b>anything</b> to run the procedures on an arbitrary number of threads. Everything is encapsulated in the <a class="el" href="classfoedus_1_1thread_1_1ThreadPool.html" title="The pool of pre-allocated threads in the engine to execute transactions. ">ThreadPool</a> class and its related classes.</p>
<h1><a class="anchor" id="EX"></a>
Examples</h1>
<p>Below is a trivial example to define a procedure and submit impersonation request. </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="engine_8hpp.html">foedus/engine.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="engine__options_8hpp.html">foedus/engine_options.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="proc__manager_8hpp.html">foedus/proc/proc_manager.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="thread__pool_8hpp.html">foedus/thread/thread_pool.hpp</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="thread_8hpp.html">foedus/thread/thread.hpp</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><a class="code" href="classfoedus_1_1ErrorStack.html">foedus::ErrorStack</a> my_proc(<span class="keyword">const</span> <a class="code" href="group__PROC.html#structfoedus_1_1proc_1_1ProcArguments">foedus::proc::ProcArguments</a>&amp; args) {</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Ya!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="group__ERRORCODES.html#ga61f52cd33eb500d6997a91e704ace244">foedus::kRetOk</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {</div>
<div class="line">  <a class="code" href="structfoedus_1_1EngineOptions.html">foedus::EngineOptions</a> options;</div>
<div class="line">  <a class="code" href="classfoedus_1_1Engine.html">foedus::Engine</a> engine(options);</div>
<div class="line">  engine.get_proc_manager()-&gt;pre_register(<span class="stringliteral">&quot;my_proc&quot;</span>, my_proc);</div>
<div class="line">  <span class="keywordflow">if</span> (engine.initialize().is_error()) {</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="classfoedus_1_1UninitializeGuard.html">foedus::UninitializeGuard</a> guard(&amp;engine);</div>
<div class="line">  <a class="code" href="classfoedus_1_1ErrorStack.html">foedus::ErrorStack</a> result = engine.get_thread_pool()-&gt;impersonate_synchronous(<span class="stringliteral">&quot;my_proc&quot;</span>);</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;result=&quot;</span> &lt;&lt; result &lt;&lt; std::endl;</div>
<div class="line">  <span class="keywordflow">if</span> (engine.uninitialize().is_error()) {</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> <div class="dynheader">
Collaboration diagram for Thread-Pool and Impersonation:</div>
<div class="dyncontent">
<center><table><tr><td><img src="group__THREADPOOL.png" border="0" alt="" usemap="#group____THREADPOOL"/>
<map name="group____THREADPOOL" id="group____THREADPOOL">
<area shape="rect" id="node2" href="group__THREAD.html" title="Thread and Thread&#45;Group, which abstracts NUMA&#45;core/node and provides API to attach/detach tasks to po..." alt="" coords="5,5,173,32"/>
</map>
</td></tr></table></center>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structfoedus_1_1thread_1_1ImpersonateSession.html">foedus::thread::ImpersonateSession</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">A user session running on an <em>impersonated</em> thread.  <a href="structfoedus_1_1thread_1_1ImpersonateSession.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1thread_1_1ThreadPool.html">foedus::thread::ThreadPool</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">The pool of pre-allocated threads in the engine to execute transactions.  <a href="classfoedus_1_1thread_1_1ThreadPool.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1thread_1_1ThreadPoolPimpl.html">foedus::thread::ThreadPoolPimpl</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Pimpl object of <a class="el" href="classfoedus_1_1thread_1_1ThreadPool.html" title="The pool of pre-allocated threads in the engine to execute transactions. ">ThreadPool</a>.  <a href="classfoedus_1_1thread_1_1ThreadPoolPimpl.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
