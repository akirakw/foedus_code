<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>libfoedus-core: foedus::storage::hash::HashComposer Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libfoedus-core
   </div>
   <div id="projectbrief">FOEDUS Core Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/centos7/"><span>Jenkins&#160;(x86_64&#160;Fedora)</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/ub1404/"><span>Jenkins&#160;(x86_64&#160;Ubuntu)</span></a></li>
      <li><a href="http://ms01915-003.hpl.hp.com:8080/"><span>Jenkins&#160;(aarch64&#160;Ubuntu)</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/tree/master"><span>Github</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/wiki"><span>Wiki</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('classfoedus_1_1storage_1_1hash_1_1HashComposer.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="classfoedus_1_1storage_1_1hash_1_1HashComposer-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">foedus::storage::hash::HashComposer Class Reference<span class="mlabels"><span class="mlabel">final</span></span><div class="ingroups"><a class="el" href="group__COMPONENTS.html">FOEDUS Components</a> &raquo; <a class="el" href="group__STORAGE.html">Storage Manager</a> &raquo; <a class="el" href="group__HASH.html">Hashtable Storage</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p><a class="el" href="classfoedus_1_1storage_1_1Composer.html" title="Represents a logic to compose a new version of data pages for one storage. ">Composer</a> for a hash storage.  
 <a href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#details">More...</a></p>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p><a class="el" href="classfoedus_1_1storage_1_1Composer.html" title="Represents a logic to compose a new version of data pages for one storage. ">Composer</a> for a hash storage. </p>
<p><a class="el" href="classfoedus_1_1storage_1_1Composer.html" title="Represents a logic to compose a new version of data pages for one storage. ">Composer</a> for hash is much easier than for B-trees, but somewhat trickier than array. Unlike B-trees, we don't have to worry about page-splits, finding where to insert, etc etc. We re-construct each hash bin always as a whole. Huuuuge simplification. Unlike array, we have a quite granular partitioning, so constructing intermediate pages is trickier. We do 2-path construction to parallelize this part without losing partitioning benefit.</p>
<h1><a class="anchor" id="HASH_COMPOSE_RESULTS"></a>
HashRootInfoPage as the results</h1>
<p>The format is exactly same as <a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashIntermediatePage.html" title="Represents an intermediate page in Hashtable Storage. ">HashIntermediatePage</a>, but typedef-ed for clarity. The only differences are: </p><ul>
<li>Snapshot pointer points to <a class="el" href="group__HASH.html#structfoedus_1_1storage_1_1hash_1_1HashComposedBinsPage" title="A page to pack many ComposedBin as an output of composer. ">HashComposedBinsPage</a> instead of HashDataPage/HashIntermediatePage. </li>
<li>Volatile pointer (which of course is never used in snapshot page) instead represents the number of contiguously-written <a class="el" href="group__HASH.html#structfoedus_1_1storage_1_1hash_1_1HashComposedBinsPage" title="A page to pack many ComposedBin as an output of composer. ">HashComposedBinsPage</a> in the pointed sub-tree. This allows the combiner to read the entire linked-list in one-shot.</li>
</ul>
<dl class="section user"><dt>Linked list of HashComposedBinsPage</dt><dd>In hash storage, what <a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a31399ce4cdbe6c2e84fe02ac7f4f5a5e">compose()</a> returns are just a list of bins. There essentially is no structure of them. The only reason we have this "root" page is to allow parallel combination by the gleaner. Each child-pointer from the root page is assigned to one thread on its own node, then written out in that node. So, after following the first child pointer, we just need a linked list, which is <a class="el" href="group__HASH.html#structfoedus_1_1storage_1_1hash_1_1HashComposedBinsPage" title="A page to pack many ComposedBin as an output of composer. ">HashComposedBinsPage</a>.</dd></dl>
<dl class="section user"><dt>2-path composition</dt><dd>Each reducer returns a linked-list of <a class="el" href="group__HASH.html#structfoedus_1_1storage_1_1hash_1_1HashComposedBinsPage" title="A page to pack many ComposedBin as an output of composer. ">HashComposedBinsPage</a> for every direct-child of the root page. Then, the gleaner combines them in a parallel fashion, resulting in snapshot interemediate pages that will be installed to the root page. The second phase consists of reading the <a class="el" href="group__HASH.html#structfoedus_1_1storage_1_1hash_1_1HashComposedBinsPage" title="A page to pack many ComposedBin as an output of composer. ">HashComposedBinsPage</a> from each composer (reducer), collecting updated bins on each page, and creating a new interemediate page hierarchically. We have several classes decoupled from the composer class itself as listed below: <ul>
<li><a class="el" href="group__HASH.html#structfoedus_1_1storage_1_1hash_1_1ComposedBin" title="Represents an output of composer on one bin. ">ComposedBin</a> (individual bin) </li>
<li><a class="el" href="group__HASH.html#structfoedus_1_1storage_1_1hash_1_1HashComposedBinsPage" title="A page to pack many ComposedBin as an output of composer. ">HashComposedBinsPage</a> (hundreds of bins) </li>
<li><a class="el" href="structfoedus_1_1storage_1_1hash_1_1ComposedBinsBuffer.html" title="Abstracts how we batch-read several HashComposedBinsPage emit from individual composers. ">ComposedBinsBuffer</a> (all bins from a sub-tree emit from one composer) </li>
<li><a class="el" href="structfoedus_1_1storage_1_1hash_1_1ComposedBinsMergedStream.html" title="Packages all ComposedBinsBuffer to easily extract bins of current interest. ">ComposedBinsMergedStream</a> (all bins from a sub-tree emit from all composers)</li>
</ul>
</dd></dl>
<dl class="section user"><dt>1-level hashtable</dt><dd>It works the same way even when the hash table has only one level (root directly points to data pages). Even in this case, HashRootInfoPage still points to <a class="el" href="group__HASH.html#structfoedus_1_1storage_1_1hash_1_1HashComposedBinsPage" title="A page to pack many ComposedBin as an output of composer. ">HashComposedBinsPage</a>, which contains only one entry per page. Kind of wasteful, but it has negligible overheads compared to the entire mapper/reducer. Unlike array package, we don't do special optimization for this case in order to keep the code simpler, and because the storage could benefit from parallelization even in this case (the root page still contains hundreds of hash bins).</dd></dl>
<dl class="section note"><dt>Note</dt><dd>This is a private implementation-details of <a class="el" href="group__HASH.html">Hashtable Storage</a>, thus file name ends with _impl. Do not include this header from a client program. There is no case client program needs to access this internal class. </dd></dl>

<p>Definition at line <a class="el" href="hash__composer__impl_8hpp_source.html#l00062">62</a> of file <a class="el" href="hash__composer__impl_8hpp_source.html">hash_composer_impl.hpp</a>.</p>
</div>
<p><code>#include &lt;<a class="el" href="hash__composer__impl_8hpp_source.html">hash_composer_impl.hpp</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:af8c61454856ee5ce11f5ddde7122ffef"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#af8c61454856ee5ce11f5ddde7122ffef">HashComposer</a> (<a class="el" href="classfoedus_1_1storage_1_1Composer.html">Composer</a> *parent)</td></tr>
<tr class="memdesc:af8c61454856ee5ce11f5ddde7122ffef"><td class="mdescLeft">&#160;</td><td class="mdescRight"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html" title="Composer for a hash storage. ">HashComposer</a> methods.  <a href="#af8c61454856ee5ce11f5ddde7122ffef">More...</a><br /></td></tr>
<tr class="separator:af8c61454856ee5ce11f5ddde7122ffef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a641bbfa48a79b406ae30d8574184f0fd"><td class="memItemLeft" align="right" valign="top">std::string&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd">to_string</a> () const </td></tr>
<tr class="separator:a641bbfa48a79b406ae30d8574184f0fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a31399ce4cdbe6c2e84fe02ac7f4f5a5e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classfoedus_1_1ErrorStack.html">ErrorStack</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a31399ce4cdbe6c2e84fe02ac7f4f5a5e">compose</a> (const <a class="el" href="group__STORAGE.html#structfoedus_1_1storage_1_1Composer_1_1ComposeArguments">Composer::ComposeArguments</a> &amp;args)</td></tr>
<tr class="separator:a31399ce4cdbe6c2e84fe02ac7f4f5a5e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac5ad2e7fa792d58965a05be6bd43e43c"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classfoedus_1_1ErrorStack.html">ErrorStack</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#ac5ad2e7fa792d58965a05be6bd43e43c">construct_root</a> (const <a class="el" href="group__STORAGE.html#structfoedus_1_1storage_1_1Composer_1_1ConstructRootArguments">Composer::ConstructRootArguments</a> &amp;args)</td></tr>
<tr class="separator:ac5ad2e7fa792d58965a05be6bd43e43c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a86416af851cf44112fbc0ea9c519c9b9"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropResult.html">Composer::DropResult</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a86416af851cf44112fbc0ea9c519c9b9">drop_volatiles</a> (const <a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropVolatilesArguments.html">Composer::DropVolatilesArguments</a> &amp;args)</td></tr>
<tr class="memdesc:a86416af851cf44112fbc0ea9c519c9b9"><td class="mdescLeft">&#160;</td><td class="mdescRight">drop_volatiles and related methods  <a href="#a86416af851cf44112fbc0ea9c519c9b9">More...</a><br /></td></tr>
<tr class="separator:a86416af851cf44112fbc0ea9c519c9b9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4a9dc98b699194503e37e0e6609872ec"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a4a9dc98b699194503e37e0e6609872ec">drop_root_volatile</a> (const <a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropVolatilesArguments.html">Composer::DropVolatilesArguments</a> &amp;args)</td></tr>
<tr class="separator:a4a9dc98b699194503e37e0e6609872ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:a02f8d5682a453898cbae7ca4a4517094"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a02f8d5682a453898cbae7ca4a4517094">launch_construct_root_multi_level</a> (<a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html">HashComposer</a> *pointer, const <a class="el" href="group__STORAGE.html#structfoedus_1_1storage_1_1Composer_1_1ConstructRootArguments">Composer::ConstructRootArguments</a> *args, uint16_t numa_node, <a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashIntermediatePage.html">HashIntermediatePage</a> *root_page, <a class="el" href="classfoedus_1_1ErrorStack.html">ErrorStack</a> *out_error)</td></tr>
<tr class="memdesc:a02f8d5682a453898cbae7ca4a4517094"><td class="mdescLeft">&#160;</td><td class="mdescRight">launched on its own thread.  <a href="#a02f8d5682a453898cbae7ca4a4517094">More...</a><br /></td></tr>
<tr class="separator:a02f8d5682a453898cbae7ca4a4517094"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="af8c61454856ee5ce11f5ddde7122ffef"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">foedus::storage::hash::HashComposer::HashComposer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classfoedus_1_1storage_1_1Composer.html">Composer</a> *&#160;</td>
          <td class="paramname"><em>parent</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">explicit</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html" title="Composer for a hash storage. ">HashComposer</a> methods. </p>

<p>Definition at line <a class="el" href="hash__composer__impl_8cpp_source.html#l00089">89</a> of file <a class="el" href="hash__composer__impl_8cpp_source.html">hash_composer_impl.cpp</a>.</p>

<p>References <a class="el" href="assert__nd_8hpp_source.html#l00072">ASSERT_ND</a>, and <a class="el" href="storage_8hpp_source.html#l00169">foedus::storage::Storage&lt; CONTROL_BLOCK &gt;::exists()</a>.</p>
<div class="fragment"><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  : engine_(parent-&gt;get_engine()),</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    storage_id_(parent-&gt;get_storage_id()),</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    storage_(engine_, storage_id_),</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    volatile_resolver_(engine_-&gt;<a class="code" href="classfoedus_1_1Engine.html#a02ed05009c7baa8d75e04f202a86b2c6">get_memory_manager</a>()-&gt;<a class="code" href="classfoedus_1_1memory_1_1EngineMemory.html#a62b2d4de6a72644e9e31d35a7f9beae0">get_global_volatile_page_resolver</a>()) {</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(storage_.<a class="code" href="classfoedus_1_1storage_1_1Storage.html#ade24602975f3928e77762f8cb4da51ca">exists</a>());</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;}</div>
<div class="ttc" id="classfoedus_1_1memory_1_1EngineMemory_html_a62b2d4de6a72644e9e31d35a7f9beae0"><div class="ttname"><a href="classfoedus_1_1memory_1_1EngineMemory.html#a62b2d4de6a72644e9e31d35a7f9beae0">foedus::memory::EngineMemory::get_global_volatile_page_resolver</a></div><div class="ttdeci">const GlobalVolatilePageResolver &amp; get_global_volatile_page_resolver() const </div><div class="ttdoc">Returns the page resolver to convert volatile page ID to page pointer. </div><div class="ttdef"><b>Definition:</b> <a href="engine__memory_8hpp_source.html#l00090">engine_memory.hpp:90</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1Storage_html_ade24602975f3928e77762f8cb4da51ca"><div class="ttname"><a href="classfoedus_1_1storage_1_1Storage.html#ade24602975f3928e77762f8cb4da51ca">foedus::storage::Storage::exists</a></div><div class="ttdeci">bool exists() const </div><div class="ttdoc">Returns whether this storage is already created. </div><div class="ttdef"><b>Definition:</b> <a href="storage_8hpp_source.html#l00169">storage.hpp:169</a></div></div>
<div class="ttc" id="group__IDIOMS_html_gaa5c1d074da423c0f330d1bc8a098ecb8"><div class="ttname"><a href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a></div><div class="ttdeci">#define ASSERT_ND(x)</div><div class="ttdoc">A warning-free wrapper macro of assert() that has no performance effect in release mode even when &#39;x&#39;...</div><div class="ttdef"><b>Definition:</b> <a href="assert__nd_8hpp_source.html#l00072">assert_nd.hpp:72</a></div></div>
<div class="ttc" id="classfoedus_1_1Engine_html_a02ed05009c7baa8d75e04f202a86b2c6"><div class="ttname"><a href="classfoedus_1_1Engine.html#a02ed05009c7baa8d75e04f202a86b2c6">foedus::Engine::get_memory_manager</a></div><div class="ttdeci">memory::EngineMemory * get_memory_manager() const </div><div class="ttdoc">See Memory Manager. </div><div class="ttdef"><b>Definition:</b> <a href="engine_8cpp_source.html#l00050">engine.cpp:50</a></div></div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_af8c61454856ee5ce11f5ddde7122ffef_cgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_af8c61454856ee5ce11f5ddde7122ffef_cgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_af8c61454856ee5ce11f5ddde7122ffef_cgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_af8c61454856ee5ce11f5ddde7122ffef_cgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1Storage.html#ade24602975f3928e77762f8cb4da51ca" title="Returns whether this storage is already created. " alt="" coords="269,5,433,47"/>
</map>
</div>
</p>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a class="anchor" id="a31399ce4cdbe6c2e84fe02ac7f4f5a5e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classfoedus_1_1ErrorStack.html">ErrorStack</a> foedus::storage::hash::HashComposer::compose </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="group__STORAGE.html#structfoedus_1_1storage_1_1Composer_1_1ComposeArguments">Composer::ComposeArguments</a> &amp;&#160;</td>
          <td class="paramname"><em>args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="hash__composer__impl_8cpp_source.html#l00097">97</a> of file <a class="el" href="hash__composer__impl_8cpp_source.html">hash_composer_impl.cpp</a>.</p>

<p>References <a class="el" href="composer_8hpp_source.html#l00110">foedus::storage::Composer::ComposeArguments::base_epoch_</a>, <a class="el" href="error__stack_8hpp_source.html#l00517">CHECK_ERROR</a>, <a class="el" href="stop__watch_8hpp_source.html#l00048">foedus::debugging::StopWatch::elapsed_ms()</a>, <a class="el" href="initializable_8hpp_source.html#l00169">foedus::DefaultInitializable::initialize()</a>, <a class="el" href="hash__id_8hpp_source.html#l00104">foedus::storage::hash::kHashMaxLevels</a>, <a class="el" href="storage__id_8hpp_source.html#l00128">foedus::storage::kHashStorage</a>, <a class="el" href="error__stack_8hpp_source.html#l00251">foedus::kRetOk</a>, <a class="el" href="composer_8hpp_source.html#l00101">foedus::storage::Composer::ComposeArguments::log_streams_</a>, <a class="el" href="composer_8hpp_source.html#l00103">foedus::storage::Composer::ComposeArguments::log_streams_count_</a>, <a class="el" href="composer_8hpp_source.html#l00099">foedus::storage::Composer::ComposeArguments::previous_snapshot_files_</a>, <a class="el" href="composer_8hpp_source.html#l00116">foedus::storage::Composer::ComposeArguments::root_info_page_</a>, <a class="el" href="composer_8hpp_source.html#l00097">foedus::storage::Composer::ComposeArguments::snapshot_writer_</a>, <a class="el" href="stop__watch_8cpp_source.html#l00035">foedus::debugging::StopWatch::stop()</a>, <a class="el" href="hash__composer__impl_8cpp_source.html#l00427">to_string()</a>, <a class="el" href="initializable_8hpp_source.html#l00187">foedus::DefaultInitializable::uninitialize()</a>, and <a class="el" href="composer_8hpp_source.html#l00105">foedus::storage::Composer::ComposeArguments::work_memory_</a>.</p>

<p>Referenced by <a class="el" href="composer_8cpp_source.html#l00061">foedus::storage::Composer::compose()</a>.</p>
<div class="fragment"><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                                                                     {</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  VLOG(0) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; composing with &quot;</span> &lt;&lt; args.log_streams_count_ &lt;&lt; <span class="stringliteral">&quot; streams.&quot;</span>;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  debugging::StopWatch stop_watch;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  snapshot::MergeSort merge_sort(</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    storage_id_,</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <a class="code" href="group__STORAGE.html#gga016025043f5ef9c02be03f2f2a17a0dea993bf93d3a4a03a67253fb2da12e3bdc">kHashStorage</a>,</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    args.base_epoch_,</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    args.log_streams_,</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    args.log_streams_count_,</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <a class="code" href="group__HASH.html#gacb6faca61be6849c9cdb02447cb3edbe">kHashMaxLevels</a>,</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    args.work_memory_);</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(merge_sort.initialize());</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  HashComposeContext context(</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    engine_,</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    &amp;merge_sort,</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    args.snapshot_writer_,</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    args.previous_snapshot_files_,</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    args.root_info_page_);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(context.execute());</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(merge_sort.uninitialize());  <span class="comment">// no need for scoped release. its destructor is safe.</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  stop_watch.stop();</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  LOG(INFO) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; done in &quot;</span> &lt;&lt; stop_watch.elapsed_ms() &lt;&lt; <span class="stringliteral">&quot;ms.&quot;</span>;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="group__ERRORCODES.html#ga61f52cd33eb500d6997a91e704ace244">kRetOk</a>;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;}</div>
<div class="ttc" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_html_a641bbfa48a79b406ae30d8574184f0fd"><div class="ttname"><a href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd">foedus::storage::hash::HashComposer::to_string</a></div><div class="ttdeci">std::string to_string() const </div><div class="ttdef"><b>Definition:</b> <a href="hash__composer__impl_8cpp_source.html#l00427">hash_composer_impl.cpp:427</a></div></div>
<div class="ttc" id="group__HASH_html_gacb6faca61be6849c9cdb02447cb3edbe"><div class="ttname"><a href="group__HASH.html#gacb6faca61be6849c9cdb02447cb3edbe">foedus::storage::hash::kHashMaxLevels</a></div><div class="ttdeci">const uint8_t kHashMaxLevels</div><div class="ttdoc">Max level of intermediate pages. </div><div class="ttdef"><b>Definition:</b> <a href="hash__id_8hpp_source.html#l00104">hash_id.hpp:104</a></div></div>
<div class="ttc" id="group__ERRORCODES_html_ga72a80915c3588aea09c053ab567e19c4"><div class="ttname"><a href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a></div><div class="ttdeci">#define CHECK_ERROR(x)</div><div class="ttdoc">This macro calls x and checks its returned value. </div><div class="ttdef"><b>Definition:</b> <a href="error__stack_8hpp_source.html#l00517">error_stack.hpp:517</a></div></div>
<div class="ttc" id="group__ERRORCODES_html_ga61f52cd33eb500d6997a91e704ace244"><div class="ttname"><a href="group__ERRORCODES.html#ga61f52cd33eb500d6997a91e704ace244">foedus::kRetOk</a></div><div class="ttdeci">const ErrorStack kRetOk</div><div class="ttdoc">Normal return value for no-error case. </div><div class="ttdef"><b>Definition:</b> <a href="error__stack_8hpp_source.html#l00251">error_stack.hpp:251</a></div></div>
<div class="ttc" id="group__STORAGE_html_gga016025043f5ef9c02be03f2f2a17a0dea993bf93d3a4a03a67253fb2da12e3bdc"><div class="ttname"><a href="group__STORAGE.html#gga016025043f5ef9c02be03f2f2a17a0dea993bf93d3a4a03a67253fb2da12e3bdc">foedus::storage::kHashStorage</a></div><div class="ttdoc">Hashtable Storage </div><div class="ttdef"><b>Definition:</b> <a href="storage__id_8hpp_source.html#l00128">storage_id.hpp:128</a></div></div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_a31399ce4cdbe6c2e84fe02ac7f4f5a5e_cgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_a31399ce4cdbe6c2e84fe02ac7f4f5a5e_cgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_a31399ce4cdbe6c2e84fe02ac7f4f5a5e_cgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_a31399ce4cdbe6c2e84fe02ac7f4f5a5e_cgraph">
<area shape="rect" id="node2" href="classfoedus_1_1debugging_1_1StopWatch.html#ac8a42ba406ab38b098e27a19e6803638" title="foedus::debugging::\lStopWatch::elapsed_ms" alt="" coords="239,71,405,112"/>
<area shape="rect" id="node3" href="classfoedus_1_1DefaultInitializable.html#a22a0dc3bbbca682c3bc41eace9b6d1ff" title="Typical implementation of Initializable::initialize() that provides initialize&#45;once semantics..." alt="" coords="236,136,408,177"/>
<area shape="rect" id="node8" href="classfoedus_1_1debugging_1_1StopWatch.html#a2ee5315a0f6bf736a2a73b29b1709bd2" title="Take another current time tick. " alt="" coords="255,267,389,308"/>
<area shape="rect" id="node11" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd" title="foedus::storage::hash\l::HashComposer::to_string" alt="" coords="233,332,411,373"/>
<area shape="rect" id="node12" href="classfoedus_1_1DefaultInitializable.html#ab14b136a7d26f9f499ab9dc15a45a8cb" title="Typical implementation of Initializable::uninitialize() that provides uninitialize&#45;once semantics..." alt="" coords="236,201,408,243"/>
<area shape="rect" id="node4" href="classfoedus_1_1DefaultInitializable.html#ab8ae37e5f20f312f8b945fc40d3e0250" title="foedus::DefaultInitializable\l::initialize_once" alt="" coords="459,5,631,47"/>
<area shape="rect" id="node5" href="classfoedus_1_1ErrorStack.html#a9c7b3a8b3806ff623c7fb4a9db5cbeec" title="Returns if this return code is not kErrorCodeOk. " alt="" coords="479,71,610,112"/>
<area shape="rect" id="node6" href="classfoedus_1_1DefaultInitializable.html#a1abda1e84b8af8bd6916e52fd0a09f3e" title="Returns whether the object has been already initialized or not. " alt="" coords="459,136,631,177"/>
<area shape="rect" id="node7" href="classfoedus_1_1DefaultInitializable.html#a764be22ce1454279e7a7e78f4c8e380b" title="foedus::DefaultInitializable\l::uninitialize_once" alt="" coords="459,201,631,243"/>
<area shape="rect" id="node9" href="classfoedus_1_1debugging_1_1StopWatch.html#adacc2b7108e7b4df019cc79733050b8c" title="foedus::debugging::\lStopWatch::elapsed_ns" alt="" coords="464,267,625,308"/>
<area shape="rect" id="node10" href="namespacefoedus_1_1debugging.html#a35a786b0492e9799cb74359408079091" title="foedus::debugging::\lget_now_nanosec" alt="" coords="477,332,612,373"/>
</map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_a31399ce4cdbe6c2e84fe02ac7f4f5a5e_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_a31399ce4cdbe6c2e84fe02ac7f4f5a5e_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_a31399ce4cdbe6c2e84fe02ac7f4f5a5e_icgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_a31399ce4cdbe6c2e84fe02ac7f4f5a5e_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1Composer.html#a28c752ec784b85418c0bfafab7ee60c0" title="Construct snapshot pages from sorted run files of one storage. " alt="" coords="233,5,412,47"/>
</map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac5ad2e7fa792d58965a05be6bd43e43c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classfoedus_1_1ErrorStack.html">ErrorStack</a> foedus::storage::hash::HashComposer::construct_root </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="group__STORAGE.html#structfoedus_1_1storage_1_1Composer_1_1ConstructRootArguments">Composer::ConstructRootArguments</a> &amp;&#160;</td>
          <td class="paramname"><em>args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="hash__composer__impl_8cpp_source.html#l00126">126</a> of file <a class="el" href="hash__composer__impl_8cpp_source.html">hash_composer_impl.cpp</a>.</p>

<p>References <a class="el" href="assert__nd_8hpp_source.html#l00072">ASSERT_ND</a>, <a class="el" href="error__stack_8hpp_source.html#l00517">CHECK_ERROR</a>, <a class="el" href="snapshot__writer__impl_8hpp_source.html#l00135">foedus::snapshot::SnapshotWriter::dump_pages()</a>, <a class="el" href="aligned__memory_8hpp_source.html#l00168">foedus::memory::AlignedMemory::get_block()</a>, <a class="el" href="attachable_8hpp_source.html#l00097">foedus::Attachable&lt; CONTROL_BLOCK &gt;::get_control_block()</a>, <a class="el" href="hash__page__impl_8hpp_source.html#l00105">foedus::storage::hash::HashIntermediatePage::get_level()</a>, <a class="el" href="hash__storage_8cpp_source.html#l00059">foedus::storage::hash::HashStorage::get_levels()</a>, <a class="el" href="storage_8hpp_source.html#l00162">foedus::storage::Storage&lt; CONTROL_BLOCK &gt;::get_metadata()</a>, <a class="el" href="snapshot__writer__impl_8hpp_source.html#l00115">foedus::snapshot::SnapshotWriter::get_next_page_id()</a>, <a class="el" href="snapshot__writer__impl_8hpp_source.html#l00102">foedus::snapshot::SnapshotWriter::get_page_base()</a>, <a class="el" href="engine_8cpp_source.html#l00074">foedus::Engine::get_soc_count()</a>, <a class="el" href="composer_8hpp_source.html#l00134">foedus::storage::Composer::ConstructRootArguments::gleaner_resource_</a>, <a class="el" href="hash__page__impl_8hpp_source.html#l00070">foedus::storage::hash::HashIntermediatePage::header()</a>, <a class="el" href="hash__page__impl_8cpp_source.html#l00058">foedus::storage::hash::HashIntermediatePage::initialize_snapshot_page()</a>, <a class="el" href="storage__id_8hpp_source.html#l00045">foedus::storage::kPageSize</a>, <a class="el" href="error__stack_8hpp_source.html#l00251">foedus::kRetOk</a>, <a class="el" href="hash__composer__impl_8hpp_source.html#l00076">launch_construct_root_multi_level()</a>, <a class="el" href="composer_8hpp_source.html#l00136">foedus::storage::Composer::ConstructRootArguments::new_root_page_pointer_</a>, <a class="el" href="page_8hpp_source.html#l00191">foedus::storage::PageHeader::page_id_</a>, <a class="el" href="composer_8hpp_source.html#l00128">foedus::storage::Composer::ConstructRootArguments::previous_snapshot_files_</a>, <a class="el" href="snapshot__file__set_8cpp_source.html#l00095">foedus::cache::SnapshotFileSet::read_page()</a>, <a class="el" href="metadata_8hpp_source.html#l00112">foedus::storage::Metadata::root_snapshot_page_id_</a>, <a class="el" href="composer_8hpp_source.html#l00126">foedus::storage::Composer::ConstructRootArguments::snapshot_writer_</a>, <a class="el" href="page_8hpp_source.html#l00196">foedus::storage::PageHeader::storage_id_</a>, <a class="el" href="log__gleaner__resource_8hpp_source.html#l00068">foedus::snapshot::LogGleanerResource::tmp_root_page_memory_</a>, <a class="el" href="hash__composer__impl_8cpp_source.html#l00427">to_string()</a>, and <a class="el" href="error__stack_8hpp_source.html#l00533">WRAP_ERROR_CODE</a>.</p>

<p>Referenced by <a class="el" href="composer_8cpp_source.html#l00072">foedus::storage::Composer::construct_root()</a>.</p>
<div class="fragment"><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                                                                                  {</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <span class="comment">// Unlike array package, this method might do lots of I/O.</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <span class="comment">// Each reducer creates only data pages. They don&#39;t create intermediate pages</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="comment">// and instead they emit linked-lists of HashComposedBinsPage as well as HashRootInfoPage</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="comment">// pointing to them. We combine these information here, writing out new intermediate pages.</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  <span class="comment">// compose() created root_info_pages that contain pointers to fill in the root page,</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="comment">// so we just find non-zero entry and copy it to root page.</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  <span class="keyword">const</span> uint8_t levels = storage_.<a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995">get_levels</a>();</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  HashIntermediatePage* root_page = <span class="keyword">reinterpret_cast&lt;</span>HashIntermediatePage*<span class="keyword">&gt;</span>(</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    args.gleaner_resource_-&gt;tmp_root_page_memory_.get_block());</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <a class="code" href="group__STORAGE.html#ga629d4b8103bfb83ef9c11b842a4fd398">SnapshotPagePointer</a> old_root_page_id = storage_.<a class="code" href="classfoedus_1_1storage_1_1Storage.html#ae3cca5dd58aa9bbf419cc07986bbc668">get_metadata</a>()-&gt;<a class="code" href="structfoedus_1_1storage_1_1Metadata.html#ab9d6a766410a36959158818af739df34">root_snapshot_page_id_</a>;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <span class="keywordflow">if</span> (old_root_page_id != 0) {</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <a class="code" href="group__ERRORCODES.html#ga952ce4f5f860d7b28a70095b450d3f4d">WRAP_ERROR_CODE</a>(args.previous_snapshot_files_-&gt;read_page(old_root_page_id, root_page));</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(root_page-&gt;header().storage_id_ == storage_id_);</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(root_page-&gt;header().page_id_ == old_root_page_id);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(root_page-&gt;get_level() + 1U == storage_.<a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995">get_levels</a>());</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    root_page-&gt;header().page_id_ = 0;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    root_page-&gt;initialize_snapshot_page(</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      storage_id_,</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      0,  <span class="comment">// new page ID not known at this point</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      storage_.<a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995">get_levels</a>() - 1U,</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;      0);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  }</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="keywordflow">if</span> (levels == 1U) {</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="comment">// single-level hash storage&#39;s root info page directly points to data pages, so</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="comment">// no need for parallelization. we separate the case below.</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(construct_root_single_level(args, root_page));</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <span class="comment">// otherwise, we parallelze the heavy lifting part, which involves raeds/writes of pages.</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    LOG(INFO) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; construct_root() multi-level parallelized path&quot;</span>;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    std::vector&lt; std::thread &gt; threads;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="keyword">const</span> uint16_t nodes = engine_-&gt;<a class="code" href="classfoedus_1_1Engine.html#af0ac9dbae9481b295a8492c6d9f6c1d5">get_soc_count</a>();</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    std::unique_ptr&lt; ErrorStack[] &gt; error_stacks(<span class="keyword">new</span> ErrorStack[nodes]);</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="keywordflow">for</span> (uint16_t numa_node = 0; numa_node &lt; nodes; ++numa_node) {</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      threads.emplace_back(</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        <a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a02f8d5682a453898cbae7ca4a4517094">HashComposer::launch_construct_root_multi_level</a>,</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        <span class="keyword">this</span>,</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        &amp;args,</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        numa_node,</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        root_page,</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        error_stacks.get() + numa_node);</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    }</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    LOG(INFO) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; construct_root() launched &quot;</span> &lt;&lt; nodes &lt;&lt; <span class="stringliteral">&quot; threads...&quot;</span>;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keywordflow">for</span> (uint16_t numa_node = 0; numa_node &lt; nodes; ++numa_node) {</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      threads[numa_node].join();</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;      <span class="keywordflow">if</span> (error_stacks.get()[numa_node].is_error()) {</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        LOG(ERROR) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; construct_root() observed an error in the launched&quot;</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;          &lt;&lt; <span class="stringliteral">&quot; thread-&quot;</span> &lt;&lt; numa_node &lt;&lt; <span class="stringliteral">&quot;. will propagate after joining the worker threads. &quot;</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;          &lt;&lt; <span class="stringliteral">&quot;error description: &quot;</span> &lt;&lt; error_stacks.get()[numa_node];</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      }</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;      <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(error_stacks.get()[numa_node]);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    }</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    LOG(INFO) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; construct_root() joined&quot;</span>;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="comment">// propagate errors.</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="keywordflow">for</span> (uint16_t numa_node = 0; numa_node &lt; nodes; ++numa_node) {</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;      <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(error_stacks.get()[numa_node]);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    }</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  }</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <span class="comment">// write out root_page image</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <a class="code" href="group__STORAGE.html#ga629d4b8103bfb83ef9c11b842a4fd398">SnapshotPagePointer</a> new_root_page_id = args.snapshot_writer_-&gt;get_next_page_id();</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  root_page-&gt;header().page_id_ = new_root_page_id;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  std::memcpy(args.snapshot_writer_-&gt;get_page_base(), root_page, <a class="code" href="group__STORAGE.html#ga1a3c05fe1d44455fc3e761947c6e21e6">kPageSize</a>);</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  <a class="code" href="group__ERRORCODES.html#ga952ce4f5f860d7b28a70095b450d3f4d">WRAP_ERROR_CODE</a>(args.snapshot_writer_-&gt;dump_pages(0, 1));</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(args.snapshot_writer_-&gt;get_next_page_id() == new_root_page_id + 1ULL);</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  *args.new_root_page_pointer_ = new_root_page_id;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  <span class="comment">// AFTER writing out the root page, install the pointer to new root page</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  storage_.<a class="code" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">get_control_block</a>()-&gt;root_page_pointer_.snapshot_pointer_ = new_root_page_id;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  storage_.<a class="code" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">get_control_block</a>()-&gt;meta_.root_snapshot_page_id_ = new_root_page_id;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="group__ERRORCODES.html#ga61f52cd33eb500d6997a91e704ace244">kRetOk</a>;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;}</div>
<div class="ttc" id="classfoedus_1_1storage_1_1hash_1_1HashStorage_html_a37d93cdda67dd88454e0237f8a511995"><div class="ttname"><a href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995">foedus::storage::hash::HashStorage::get_levels</a></div><div class="ttdeci">uint8_t get_levels() const </div><div class="ttdef"><b>Definition:</b> <a href="hash__storage_8cpp_source.html#l00059">hash_storage.cpp:59</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1Storage_html_ae3cca5dd58aa9bbf419cc07986bbc668"><div class="ttname"><a href="classfoedus_1_1storage_1_1Storage.html#ae3cca5dd58aa9bbf419cc07986bbc668">foedus::storage::Storage::get_metadata</a></div><div class="ttdeci">const Metadata * get_metadata() const </div><div class="ttdoc">Returns the metadata of this storage. </div><div class="ttdef"><b>Definition:</b> <a href="storage_8hpp_source.html#l00162">storage.hpp:162</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_html_a02f8d5682a453898cbae7ca4a4517094"><div class="ttname"><a href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a02f8d5682a453898cbae7ca4a4517094">foedus::storage::hash::HashComposer::launch_construct_root_multi_level</a></div><div class="ttdeci">static void launch_construct_root_multi_level(HashComposer *pointer, const Composer::ConstructRootArguments *args, uint16_t numa_node, HashIntermediatePage *root_page, ErrorStack *out_error)</div><div class="ttdoc">launched on its own thread. </div><div class="ttdef"><b>Definition:</b> <a href="hash__composer__impl_8hpp_source.html#l00076">hash_composer_impl.hpp:76</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_html_a641bbfa48a79b406ae30d8574184f0fd"><div class="ttname"><a href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd">foedus::storage::hash::HashComposer::to_string</a></div><div class="ttdeci">std::string to_string() const </div><div class="ttdef"><b>Definition:</b> <a href="hash__composer__impl_8cpp_source.html#l00427">hash_composer_impl.cpp:427</a></div></div>
<div class="ttc" id="classfoedus_1_1Engine_html_af0ac9dbae9481b295a8492c6d9f6c1d5"><div class="ttname"><a href="classfoedus_1_1Engine.html#af0ac9dbae9481b295a8492c6d9f6c1d5">foedus::Engine::get_soc_count</a></div><div class="ttdeci">soc::SocId get_soc_count() const </div><div class="ttdoc">Shorthand for get_options().thread_.group_count_. </div><div class="ttdef"><b>Definition:</b> <a href="engine_8cpp_source.html#l00074">engine.cpp:74</a></div></div>
<div class="ttc" id="group__STORAGE_html_ga629d4b8103bfb83ef9c11b842a4fd398"><div class="ttname"><a href="group__STORAGE.html#ga629d4b8103bfb83ef9c11b842a4fd398">foedus::storage::SnapshotPagePointer</a></div><div class="ttdeci">uint64_t SnapshotPagePointer</div><div class="ttdoc">Page ID of a snapshot page. </div><div class="ttdef"><b>Definition:</b> <a href="storage__id_8hpp_source.html#l00079">storage_id.hpp:79</a></div></div>
<div class="ttc" id="group__ERRORCODES_html_ga72a80915c3588aea09c053ab567e19c4"><div class="ttname"><a href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a></div><div class="ttdeci">#define CHECK_ERROR(x)</div><div class="ttdoc">This macro calls x and checks its returned value. </div><div class="ttdef"><b>Definition:</b> <a href="error__stack_8hpp_source.html#l00517">error_stack.hpp:517</a></div></div>
<div class="ttc" id="group__ERRORCODES_html_ga61f52cd33eb500d6997a91e704ace244"><div class="ttname"><a href="group__ERRORCODES.html#ga61f52cd33eb500d6997a91e704ace244">foedus::kRetOk</a></div><div class="ttdeci">const ErrorStack kRetOk</div><div class="ttdoc">Normal return value for no-error case. </div><div class="ttdef"><b>Definition:</b> <a href="error__stack_8hpp_source.html#l00251">error_stack.hpp:251</a></div></div>
<div class="ttc" id="group__IDIOMS_html_gaa5c1d074da423c0f330d1bc8a098ecb8"><div class="ttname"><a href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a></div><div class="ttdeci">#define ASSERT_ND(x)</div><div class="ttdoc">A warning-free wrapper macro of assert() that has no performance effect in release mode even when &#39;x&#39;...</div><div class="ttdef"><b>Definition:</b> <a href="assert__nd_8hpp_source.html#l00072">assert_nd.hpp:72</a></div></div>
<div class="ttc" id="group__ERRORCODES_html_ga952ce4f5f860d7b28a70095b450d3f4d"><div class="ttname"><a href="group__ERRORCODES.html#ga952ce4f5f860d7b28a70095b450d3f4d">WRAP_ERROR_CODE</a></div><div class="ttdeci">#define WRAP_ERROR_CODE(x)</div><div class="ttdoc">Same as CHECK_ERROR(x) except it receives only an error code, thus more efficient. </div><div class="ttdef"><b>Definition:</b> <a href="error__stack_8hpp_source.html#l00533">error_stack.hpp:533</a></div></div>
<div class="ttc" id="classfoedus_1_1Attachable_html_a5b324e3abf302a59801aa73419bb4fad"><div class="ttname"><a href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">foedus::Attachable::get_control_block</a></div><div class="ttdeci">CONTROL_BLOCK * get_control_block() const </div><div class="ttdef"><b>Definition:</b> <a href="attachable_8hpp_source.html#l00097">attachable.hpp:97</a></div></div>
<div class="ttc" id="group__STORAGE_html_ga1a3c05fe1d44455fc3e761947c6e21e6"><div class="ttname"><a href="group__STORAGE.html#ga1a3c05fe1d44455fc3e761947c6e21e6">foedus::storage::kPageSize</a></div><div class="ttdeci">const uint16_t kPageSize</div><div class="ttdoc">A constant defining the page size (in bytes) of both snapshot pages and volatile pages. </div><div class="ttdef"><b>Definition:</b> <a href="storage__id_8hpp_source.html#l00045">storage_id.hpp:45</a></div></div>
<div class="ttc" id="structfoedus_1_1storage_1_1Metadata_html_ab9d6a766410a36959158818af739df34"><div class="ttname"><a href="structfoedus_1_1storage_1_1Metadata.html#ab9d6a766410a36959158818af739df34">foedus::storage::Metadata::root_snapshot_page_id_</a></div><div class="ttdeci">SnapshotPagePointer root_snapshot_page_id_</div><div class="ttdoc">Pointer to a snapshotted page this storage is rooted at. </div><div class="ttdef"><b>Definition:</b> <a href="metadata_8hpp_source.html#l00112">metadata.hpp:112</a></div></div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_ac5ad2e7fa792d58965a05be6bd43e43c_cgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_ac5ad2e7fa792d58965a05be6bd43e43c_cgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_ac5ad2e7fa792d58965a05be6bd43e43c_cgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_ac5ad2e7fa792d58965a05be6bd43e43c_cgraph">
<area shape="rect" id="node2" href="classfoedus_1_1snapshot_1_1SnapshotWriter.html#a55ba9fc4a87f71b3991bba1c39948cc9" title="Write out pages that are contiguous in the main page pool. " alt="" coords="265,5,449,47"/>
<area shape="rect" id="node3" href="classfoedus_1_1memory_1_1AlignedMemory.html#af306ba60622e2a87f75ae93dc6c597b1" title="Returns the memory block. " alt="" coords="499,93,712,135"/>
<area shape="rect" id="node4" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad" title="foedus::Attachable\l::get_control_block" alt="" coords="291,188,423,229"/>
<area shape="rect" id="node5" href="classfoedus_1_1storage_1_1hash_1_1HashIntermediatePage.html#a6ddc93fb5df01249140895435819da2f" title="foedus::storage::hash\l::HashIntermediatePage\l::get_level" alt="" coords="277,254,438,310"/>
<area shape="rect" id="node7" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995" title="foedus::storage::hash\l::HashStorage::get_levels" alt="" coords="272,335,443,376"/>
<area shape="rect" id="node8" href="classfoedus_1_1storage_1_1Storage.html#ae3cca5dd58aa9bbf419cc07986bbc668" title="Returns the metadata of this storage. " alt="" coords="275,400,439,441"/>
<area shape="rect" id="node9" href="classfoedus_1_1snapshot_1_1SnapshotWriter.html#af9bcb8a605aecbbc3eabdc6664f6b163" title="foedus::snapshot::Snapshot\lWriter::get_next_page_id" alt="" coords="265,465,449,507"/>
<area shape="rect" id="node10" href="classfoedus_1_1snapshot_1_1SnapshotWriter.html#a4f72263ae71f34fad0130151328d6720" title="foedus::snapshot::Snapshot\lWriter::get_page_base" alt="" coords="265,123,449,164"/>
<area shape="rect" id="node11" href="classfoedus_1_1Engine.html#af0ac9dbae9481b295a8492c6d9f6c1d5" title="Shorthand for get_options().thread_.group_count_. " alt="" coords="290,531,425,572"/>
<area shape="rect" id="node12" href="classfoedus_1_1storage_1_1hash_1_1HashIntermediatePage.html#a134e444d2b945700fe14d0d6d3dd11f0" title="foedus::storage::hash\l::HashIntermediatePage\l::header" alt="" coords="277,597,438,653"/>
<area shape="rect" id="node13" href="classfoedus_1_1storage_1_1hash_1_1HashIntermediatePage.html#a6b20dce9484c09666d6cf1df866d00d3" title="foedus::storage::hash\l::HashIntermediatePage\l::initialize_snapshot_page" alt="" coords="271,677,443,733"/>
<area shape="rect" id="node22" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a02f8d5682a453898cbae7ca4a4517094" title="launched on its own thread. " alt="" coords="268,823,447,879"/>
<area shape="rect" id="node23" href="classfoedus_1_1cache_1_1SnapshotFileSet.html#ad7ea1e9815cd47c3175371d37974526a" title="foedus::cache::SnapshotFile\lSet::read_page" alt="" coords="264,757,451,799"/>
<area shape="rect" id="node35" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a641bbfa48a79b406ae30d8574184f0fd" title="foedus::storage::hash\l::HashComposer::to_string" alt="" coords="269,904,446,945"/>
<area shape="rect" id="node6" href="structfoedus_1_1storage_1_1PageHeader.html#ac40b3dad0a38d9a142bd14ea5000b669" title="foedus::storage::PageHeader\l::get_in_layer_level" alt="" coords="510,261,701,303"/>
<area shape="rect" id="node14" href="structfoedus_1_1storage_1_1PageHeader.html#a65c4acd213d2f482eb29c6dee0818915" title="foedus::storage::PageHeader\l::init_snapshot" alt="" coords="510,579,701,620"/>
<area shape="rect" id="node21" href="structfoedus_1_1storage_1_1PageHeader.html#a1956943904b68b6472f53b4e9ed6df87" title="foedus::storage::PageHeader\l::set_in_layer_level" alt="" coords="510,652,701,693"/>
<area shape="rect" id="node15" href="namespacefoedus_1_1storage.html#a8f6e96ac10eb804602349a54292d26a1" title="foedus::storage::extract\l_numa_node_from_snapshot\l_pointer" alt="" coords="765,638,953,694"/>
<area shape="rect" id="node16" href="structfoedus_1_1assorted_1_1ProbCounter.html#a8e7b31f9a6b4997f6c0916f7e20d755a" title="foedus::assorted::ProbCounter\l::reset" alt="" coords="760,572,959,613"/>
<area shape="rect" id="node17" href="structfoedus_1_1storage_1_1PageVersion.html#ae40168c82f16645e85bb66f9019e53cf" title="used only while page initialization " alt="" coords="763,507,955,548"/>
<area shape="rect" id="node18" href="structfoedus_1_1storage_1_1PageVersionStatus.html#af49ef4f3320148130f46f494f1c845aa" title="foedus::storage::PageVersion\lStatus::reset" alt="" coords="1007,540,1199,581"/>
<area shape="rect" id="node19" href="structfoedus_1_1xct_1_1McsWwLock.html#a4114c2dec151ad650a294dedac4f239d" title="used only while page initialization " alt="" coords="1018,475,1187,516"/>
<area shape="rect" id="node20" href="structfoedus_1_1xct_1_1McsWwBlockData.html#a3161e47c41388e9c1b50929f585e366b" title="foedus::xct::McsWwBlockData\l::clear" alt="" coords="1247,475,1448,516"/>
<area shape="rect" id="node24" href="namespacefoedus_1_1storage.html#a3c3e7a984303d1ef88e001db1591b1be" title="foedus::storage::extract\l_local_page_id_from_snapshot\l_pointer" alt="" coords="505,783,705,839"/>
<area shape="rect" id="node25" href="classfoedus_1_1cache_1_1SnapshotFileSet.html#ae5b153acb9f3115c44a48e10ff2262fb" title="foedus::cache::SnapshotFile\lSet::get_or_open_file" alt="" coords="512,717,699,759"/>
<area shape="rect" id="node27" href="classfoedus_1_1fs_1_1DirectIoFile.html#a5353bbb3b2a815d6c858c8190edeccf4" title="A version that receives a raw pointer that has to be aligned (be careful to use this ver)..." alt="" coords="530,929,681,971"/>
<area shape="rect" id="node34" href="classfoedus_1_1fs_1_1DirectIoFile.html#a35814dfec4dab81d5bb46e453f1993e6" title="Sets the position of the next byte to be written/extracted from/to the stream. " alt="" coords="530,864,681,905"/>
<area shape="rect" id="node26" href="namespacefoedus_1_1storage.html#a82df0b3921d7c863275baf4f9c59959c" title="foedus::storage::extract\l_snapshot_id_from_snapshot\l_pointer" alt="" coords="764,718,955,774"/>
<area shape="rect" id="node28" href="namespacefoedus_1_1fs.html#a1a3ea81bf627928d9a5f154986af9c48" title="foedus::fs::is_odirect\l_aligned" alt="" coords="788,929,931,971"/>
<area shape="rect" id="node29" href="classfoedus_1_1fs_1_1DirectIoFile.html#a1d89a9c761a388f13f9b59490b6caa00" title="Whether the file is already and successfully opened. " alt="" coords="784,1060,935,1101"/>
<area shape="rect" id="node30" href="group__ASSORTED.html#gaaa260096daf8620266c2799d1f5a0270" title="Thread&#45;safe strerror(errno). " alt="" coords="789,799,929,840"/>
<area shape="rect" id="node31" href="classfoedus_1_1fs_1_1DirectIoFile.html#a1c6bff6aafc955fd4c2a8e11e7f41f40" title="Sequentially read the given amount of contents from the current position. " alt="" coords="784,995,935,1036"/>
<area shape="rect" id="node32" href="group__DEBUGGING.html#gac7eac15b41b0fab4e689f62d147ce620" title="Wait until the given CPU cycles elapse. " alt="" coords="792,864,927,905"/>
<area shape="rect" id="node33" href="group__DEBUGGING.html#ga48dd46b3a1382506a34fcb4e6e0941f6" title="Returns the current CPU cycle via x86 RDTSC. " alt="" coords="1035,864,1170,905"/>
</map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_ac5ad2e7fa792d58965a05be6bd43e43c_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_ac5ad2e7fa792d58965a05be6bd43e43c_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_ac5ad2e7fa792d58965a05be6bd43e43c_icgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_ac5ad2e7fa792d58965a05be6bd43e43c_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1Composer.html#adf148cbea7c8146dec88d23d2218452c" title="Construct root page(s) for one storage based on the ouputs of compose(). " alt="" coords="264,5,443,47"/>
</map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4a9dc98b699194503e37e0e6609872ec"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void foedus::storage::hash::HashComposer::drop_root_volatile </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropVolatilesArguments.html">Composer::DropVolatilesArguments</a> &amp;&#160;</td>
          <td class="paramname"><em>args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="hash__composer__impl_8cpp_source.html#l01223">1223</a> of file <a class="el" href="hash__composer__impl_8cpp_source.html">hash_composer_impl.cpp</a>.</p>

<p>References <a class="el" href="attachable_8hpp_source.html#l00097">foedus::Attachable&lt; CONTROL_BLOCK &gt;::get_control_block()</a>, <a class="el" href="hash__storage_8cpp_source.html#l00078">foedus::storage::hash::HashStorage::get_hash_metadata()</a>, <a class="el" href="hash__storage_8cpp_source.html#l00059">foedus::storage::hash::HashStorage::get_levels()</a>, <a class="el" href="storage_8hpp_source.html#l00155">foedus::storage::Storage&lt; CONTROL_BLOCK &gt;::get_name()</a>, <a class="el" href="metadata_8hpp_source.html#l00098">foedus::storage::Metadata::keeps_all_volatile_pages()</a>, and <a class="el" href="storage__id_8hpp_source.html#l00308">foedus::storage::DualPagePointer::volatile_pointer_</a>.</p>

<p>Referenced by <a class="el" href="composer_8cpp_source.html#l00094">foedus::storage::Composer::drop_root_volatile()</a>.</p>
<div class="fragment"><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;                                                                                {</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;  <span class="keywordflow">if</span> (storage_.<a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a47a258c2edd9e4d3b3b4a5b472a07d62">get_hash_metadata</a>()-&gt;<a class="code" href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b">keeps_all_volatile_pages</a>()) {</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Oh, but keep-all-volatile is on. Storage-&quot;</span> &lt;&lt; storage_.<a class="code" href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01">get_name</a>()</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;      &lt;&lt; <span class="stringliteral">&quot; is configured to keep all volatile pages.&quot;</span>;</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;  }</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;  <span class="keywordflow">if</span> (is_to_keep_volatile(storage_.<a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995">get_levels</a>() - 1U)) {</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Oh, but Storage-&quot;</span> &lt;&lt; storage_.<a class="code" href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01">get_name</a>() &lt;&lt; <span class="stringliteral">&quot; is configured to keep&quot;</span></div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;      &lt;&lt; <span class="stringliteral">&quot; the root page.&quot;</span>;</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;  }</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;  DualPagePointer* root_pointer = &amp;storage_.<a class="code" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">get_control_block</a>()-&gt;root_page_pointer_;</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;  HashIntermediatePage* volatile_page = resolve_intermediate(root_pointer-&gt;volatile_pointer_);</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;  <span class="keywordflow">if</span> (volatile_page == <span class="keyword">nullptr</span>) {</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Oh, but root volatile page already null&quot;</span>;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;  }</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;  LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Okay, drop em all!!&quot;</span>;</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;  drop_all_recurse(args, root_pointer);</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;}</div>
<div class="ttc" id="classfoedus_1_1storage_1_1hash_1_1HashStorage_html_a37d93cdda67dd88454e0237f8a511995"><div class="ttname"><a href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995">foedus::storage::hash::HashStorage::get_levels</a></div><div class="ttdeci">uint8_t get_levels() const </div><div class="ttdef"><b>Definition:</b> <a href="hash__storage_8cpp_source.html#l00059">hash_storage.cpp:59</a></div></div>
<div class="ttc" id="structfoedus_1_1storage_1_1Metadata_html_a675df0db1a3c909581db949c10fd192b"><div class="ttname"><a href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b">foedus::storage::Metadata::keeps_all_volatile_pages</a></div><div class="ttdeci">bool keeps_all_volatile_pages() const </div><div class="ttdef"><b>Definition:</b> <a href="metadata_8hpp_source.html#l00098">metadata.hpp:98</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1Storage_html_ac1b54d4e7f3ad9f7f7c17598911abb01"><div class="ttname"><a href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01">foedus::storage::Storage::get_name</a></div><div class="ttdeci">const StorageName &amp; get_name() const </div><div class="ttdoc">Returns the unique name of this storage. </div><div class="ttdef"><b>Definition:</b> <a href="storage_8hpp_source.html#l00155">storage.hpp:155</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1hash_1_1HashStorage_html_a47a258c2edd9e4d3b3b4a5b472a07d62"><div class="ttname"><a href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a47a258c2edd9e4d3b3b4a5b472a07d62">foedus::storage::hash::HashStorage::get_hash_metadata</a></div><div class="ttdeci">const HashMetadata * get_hash_metadata() const </div><div class="ttdef"><b>Definition:</b> <a href="hash__storage_8cpp_source.html#l00078">hash_storage.cpp:78</a></div></div>
<div class="ttc" id="classfoedus_1_1Attachable_html_a5b324e3abf302a59801aa73419bb4fad"><div class="ttname"><a href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">foedus::Attachable::get_control_block</a></div><div class="ttdeci">CONTROL_BLOCK * get_control_block() const </div><div class="ttdef"><b>Definition:</b> <a href="attachable_8hpp_source.html#l00097">attachable.hpp:97</a></div></div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_a4a9dc98b699194503e37e0e6609872ec_cgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_a4a9dc98b699194503e37e0e6609872ec_cgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_a4a9dc98b699194503e37e0e6609872ec_cgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_a4a9dc98b699194503e37e0e6609872ec_cgraph">
<area shape="rect" id="node2" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad" title="foedus::Attachable\l::get_control_block" alt="" coords="226,5,358,47"/>
<area shape="rect" id="node3" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a47a258c2edd9e4d3b3b4a5b472a07d62" title="foedus::storage::hash\l::HashStorage::get_hash\l_metadata" alt="" coords="209,71,375,127"/>
<area shape="rect" id="node4" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995" title="foedus::storage::hash\l::HashStorage::get_levels" alt="" coords="207,152,377,193"/>
<area shape="rect" id="node5" href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01" title="Returns the unique name of this storage. " alt="" coords="210,217,374,259"/>
<area shape="rect" id="node6" href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b" title="foedus::storage::Metadata\l::keeps_all_volatile_pages" alt="" coords="205,283,379,324"/>
</map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_a4a9dc98b699194503e37e0e6609872ec_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_a4a9dc98b699194503e37e0e6609872ec_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_a4a9dc98b699194503e37e0e6609872ec_icgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_a4a9dc98b699194503e37e0e6609872ec_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1Composer.html#af6d90399f471e1461fd4e59b0f3b923f" title="This is additionally called when no partitions observed any new modifications. " alt="" coords="205,39,384,80"/>
<area shape="rect" id="node3" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a5d474e7a6b4de127153103f2295cb0fa" title="Sub&#45;routine of handle_snapshot_triggered(). " alt="" coords="432,39,659,80"/>
<area shape="rect" id="node4" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a905ccf76fe0e076980dc1965f038fe10" title="handle_snapshot() calls this when it should start snapshotting. " alt="" coords="707,31,917,87"/>
<area shape="rect" id="node5" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a64e3c7594b7d7d0d5f8a144bd802d910" title="Main routine for snapshot_thread_ in master engine. " alt="" coords="965,5,1176,47"/>
<area shape="rect" id="node7" href="classfoedus_1_1restart_1_1RestartManagerPimpl.html#a8c5418a3e6d3558aa3920a605834df08" title="Recover the state of database from recent snapshot files and transaction logs. " alt="" coords="993,71,1148,112"/>
<area shape="rect" id="node6" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a632a4da7b3c67dd687f7eba4f6ec1d76" title="foedus::snapshot::Snapshot\lManagerPimpl::initialize_once" alt="" coords="1224,5,1419,47"/>
<area shape="rect" id="node8" href="classfoedus_1_1restart_1_1RestartManagerPimpl.html#a868dca9015af77e04202ead68fd7a136" title="foedus::restart::Restart\lManagerPimpl::initialize_once" alt="" coords="1224,71,1419,112"/>
</map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a86416af851cf44112fbc0ea9c519c9b9"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropResult.html">Composer::DropResult</a> foedus::storage::hash::HashComposer::drop_volatiles </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropVolatilesArguments.html">Composer::DropVolatilesArguments</a> &amp;&#160;</td>
          <td class="paramname"><em>args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>drop_volatiles and related methods </p>

<p>Definition at line <a class="el" href="hash__composer__impl_8cpp_source.html#l01165">1165</a> of file <a class="el" href="hash__composer__impl_8cpp_source.html">hash_composer_impl.cpp</a>.</p>

<p>References <a class="el" href="assert__nd_8hpp_source.html#l00072">ASSERT_ND</a>, <a class="el" href="composer_8hpp_source.html#l00202">foedus::storage::Composer::DropResult::dropped_all_</a>, <a class="el" href="storage__id_8hpp_source.html#l00095">foedus::storage::extract_numa_node_from_snapshot_pointer()</a>, <a class="el" href="attachable_8hpp_source.html#l00097">foedus::Attachable&lt; CONTROL_BLOCK &gt;::get_control_block()</a>, <a class="el" href="hash__storage_8cpp_source.html#l00078">foedus::storage::hash::HashStorage::get_hash_metadata()</a>, <a class="el" href="hash__page__impl_8hpp_source.html#l00105">foedus::storage::hash::HashIntermediatePage::get_level()</a>, <a class="el" href="hash__storage_8cpp_source.html#l00059">foedus::storage::hash::HashStorage::get_levels()</a>, <a class="el" href="storage_8hpp_source.html#l00155">foedus::storage::Storage&lt; CONTROL_BLOCK &gt;::get_name()</a>, <a class="el" href="hash__page__impl_8hpp_source.html#l00080">foedus::storage::hash::HashIntermediatePage::get_pointer()</a>, <a class="el" href="hash__storage_8cpp_source.html#l00063">foedus::storage::hash::HashStorage::get_root_children()</a>, <a class="el" href="storage__id_8hpp_source.html#l00210">foedus::storage::VolatilePagePointer::is_null()</a>, <a class="el" href="metadata_8hpp_source.html#l00098">foedus::storage::Metadata::keeps_all_volatile_pages()</a>, <a class="el" href="composer_8hpp_source.html#l00152">foedus::storage::Composer::DropVolatilesArguments::my_partition_</a>, <a class="el" href="composer_8hpp_source.html#l00154">foedus::storage::Composer::DropVolatilesArguments::partitioned_drop_</a>, <a class="el" href="storage__id_8hpp_source.html#l00307">foedus::storage::DualPagePointer::snapshot_pointer_</a>, and <a class="el" href="storage__id_8hpp_source.html#l00308">foedus::storage::DualPagePointer::volatile_pointer_</a>.</p>

<p>Referenced by <a class="el" href="composer_8cpp_source.html#l00083">foedus::storage::Composer::drop_volatiles()</a>.</p>
<div class="fragment"><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;                                                                                          {</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;  Composer::DropResult result(args);</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  <span class="keywordflow">if</span> (storage_.<a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a47a258c2edd9e4d3b3b4a5b472a07d62">get_hash_metadata</a>()-&gt;<a class="code" href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b">keeps_all_volatile_pages</a>()) {</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Keep-all-volatile: Storage-&quot;</span> &lt;&lt; storage_.<a class="code" href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01">get_name</a>()</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;      &lt;&lt; <span class="stringliteral">&quot; is configured to keep all volatile pages.&quot;</span>;</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;    result.dropped_all_ = <span class="keyword">false</span>;</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;  }</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;  DualPagePointer* root_pointer = &amp;storage_.<a class="code" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">get_control_block</a>()-&gt;root_page_pointer_;</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;  HashIntermediatePage* volatile_page = resolve_intermediate(root_pointer-&gt;volatile_pointer_);</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;  <span class="keywordflow">if</span> (volatile_page == <span class="keyword">nullptr</span>) {</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;No volatile root page. Probably while restart&quot;</span>;</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;  }</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;  <span class="comment">// We iterate through all existing volatile pages to drop volatile pages of</span></div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;  <span class="comment">// level-3 or deeper (if the storage has only 2 levels, keeps all).</span></div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;  <span class="comment">// this &quot;level-3 or deeper&quot; is a configuration per storage.</span></div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;  <span class="comment">// Even if the volatile page is deeper than that, we keep them if it contains newer modification,</span></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;  <span class="comment">// including descendants (so, probably we will keep higher levels anyways).</span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;  uint16_t count = storage_.<a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a0f94a4a418776e5ac253b6dcccda8cc6">get_root_children</a>();</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;  uint8_t root_level = volatile_page-&gt;get_level();</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(root_level + 1U == storage_.<a class="code" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995">get_levels</a>());</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;  <span class="keywordflow">for</span> (uint16_t i = 0; i &lt; count; ++i) {</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    DualPagePointer&amp; child_pointer = volatile_page-&gt;get_pointer(i);</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <span class="keywordflow">if</span> (!child_pointer.volatile_pointer_.is_null() &amp;&amp; child_pointer.snapshot_pointer_ != 0) {</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;      uint16_t partition = <a class="code" href="namespacefoedus_1_1storage.html#a8f6e96ac10eb804602349a54292d26a1">extract_numa_node_from_snapshot_pointer</a>(child_pointer.snapshot_pointer_);</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;      <span class="keywordflow">if</span> (!args.partitioned_drop_ || partition == args.my_partition_) {</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        drop_volatiles_child(args, &amp;child_pointer, root_level, &amp;result);</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;      }</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    }</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;  }</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;  <span class="comment">// root page is kept at this point in this case. we need to check with other threads</span></div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;  <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;}</div>
<div class="ttc" id="classfoedus_1_1storage_1_1hash_1_1HashStorage_html_a37d93cdda67dd88454e0237f8a511995"><div class="ttname"><a href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995">foedus::storage::hash::HashStorage::get_levels</a></div><div class="ttdeci">uint8_t get_levels() const </div><div class="ttdef"><b>Definition:</b> <a href="hash__storage_8cpp_source.html#l00059">hash_storage.cpp:59</a></div></div>
<div class="ttc" id="structfoedus_1_1storage_1_1Metadata_html_a675df0db1a3c909581db949c10fd192b"><div class="ttname"><a href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b">foedus::storage::Metadata::keeps_all_volatile_pages</a></div><div class="ttdeci">bool keeps_all_volatile_pages() const </div><div class="ttdef"><b>Definition:</b> <a href="metadata_8hpp_source.html#l00098">metadata.hpp:98</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1Storage_html_ac1b54d4e7f3ad9f7f7c17598911abb01"><div class="ttname"><a href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01">foedus::storage::Storage::get_name</a></div><div class="ttdeci">const StorageName &amp; get_name() const </div><div class="ttdoc">Returns the unique name of this storage. </div><div class="ttdef"><b>Definition:</b> <a href="storage_8hpp_source.html#l00155">storage.hpp:155</a></div></div>
<div class="ttc" id="namespacefoedus_1_1storage_html_a8f6e96ac10eb804602349a54292d26a1"><div class="ttname"><a href="namespacefoedus_1_1storage.html#a8f6e96ac10eb804602349a54292d26a1">foedus::storage::extract_numa_node_from_snapshot_pointer</a></div><div class="ttdeci">uint8_t extract_numa_node_from_snapshot_pointer(SnapshotPagePointer pointer)</div><div class="ttdef"><b>Definition:</b> <a href="storage__id_8hpp_source.html#l00095">storage_id.hpp:95</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1hash_1_1HashStorage_html_a47a258c2edd9e4d3b3b4a5b472a07d62"><div class="ttname"><a href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a47a258c2edd9e4d3b3b4a5b472a07d62">foedus::storage::hash::HashStorage::get_hash_metadata</a></div><div class="ttdeci">const HashMetadata * get_hash_metadata() const </div><div class="ttdef"><b>Definition:</b> <a href="hash__storage_8cpp_source.html#l00078">hash_storage.cpp:78</a></div></div>
<div class="ttc" id="group__IDIOMS_html_gaa5c1d074da423c0f330d1bc8a098ecb8"><div class="ttname"><a href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a></div><div class="ttdeci">#define ASSERT_ND(x)</div><div class="ttdoc">A warning-free wrapper macro of assert() that has no performance effect in release mode even when &#39;x&#39;...</div><div class="ttdef"><b>Definition:</b> <a href="assert__nd_8hpp_source.html#l00072">assert_nd.hpp:72</a></div></div>
<div class="ttc" id="classfoedus_1_1Attachable_html_a5b324e3abf302a59801aa73419bb4fad"><div class="ttname"><a href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">foedus::Attachable::get_control_block</a></div><div class="ttdeci">CONTROL_BLOCK * get_control_block() const </div><div class="ttdef"><b>Definition:</b> <a href="attachable_8hpp_source.html#l00097">attachable.hpp:97</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1hash_1_1HashStorage_html_a0f94a4a418776e5ac253b6dcccda8cc6"><div class="ttname"><a href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a0f94a4a418776e5ac253b6dcccda8cc6">foedus::storage::hash::HashStorage::get_root_children</a></div><div class="ttdeci">uint16_t get_root_children() const </div><div class="ttdef"><b>Definition:</b> <a href="hash__storage_8cpp_source.html#l00063">hash_storage.cpp:63</a></div></div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_a86416af851cf44112fbc0ea9c519c9b9_cgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_a86416af851cf44112fbc0ea9c519c9b9_cgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_a86416af851cf44112fbc0ea9c519c9b9_cgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_a86416af851cf44112fbc0ea9c519c9b9_cgraph">
<area shape="rect" id="node2" href="namespacefoedus_1_1storage.html#a8f6e96ac10eb804602349a54292d26a1" title="foedus::storage::extract\l_numa_node_from_snapshot\l_pointer" alt="" coords="205,5,393,61"/>
<area shape="rect" id="node3" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad" title="foedus::Attachable\l::get_control_block" alt="" coords="233,86,365,127"/>
<area shape="rect" id="node4" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a47a258c2edd9e4d3b3b4a5b472a07d62" title="foedus::storage::hash\l::HashStorage::get_hash\l_metadata" alt="" coords="216,152,383,208"/>
<area shape="rect" id="node5" href="classfoedus_1_1storage_1_1hash_1_1HashIntermediatePage.html#a6ddc93fb5df01249140895435819da2f" title="foedus::storage::hash\l::HashIntermediatePage\l::get_level" alt="" coords="219,232,380,288"/>
<area shape="rect" id="node7" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a37d93cdda67dd88454e0237f8a511995" title="foedus::storage::hash\l::HashStorage::get_levels" alt="" coords="214,313,385,354"/>
<area shape="rect" id="node8" href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01" title="Returns the unique name of this storage. " alt="" coords="217,378,381,419"/>
<area shape="rect" id="node9" href="classfoedus_1_1storage_1_1hash_1_1HashIntermediatePage.html#a9027ebbc2ee535519916906978347be9" title="foedus::storage::hash\l::HashIntermediatePage\l::get_pointer" alt="" coords="219,444,380,500"/>
<area shape="rect" id="node10" href="classfoedus_1_1storage_1_1hash_1_1HashStorage.html#a0f94a4a418776e5ac253b6dcccda8cc6" title="foedus::storage::hash\l::HashStorage::get_root\l_children" alt="" coords="219,524,379,580"/>
<area shape="rect" id="node11" href="structfoedus_1_1storage_1_1VolatilePagePointer.html#ad9d25c0d8211f93db82d8cefe9d6ead7" title="foedus::storage::Volatile\lPagePointer::is_null" alt="" coords="219,605,380,646"/>
<area shape="rect" id="node13" href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b" title="foedus::storage::Metadata\l::keeps_all_volatile_pages" alt="" coords="213,670,386,711"/>
<area shape="rect" id="node6" href="structfoedus_1_1storage_1_1PageHeader.html#ac40b3dad0a38d9a142bd14ea5000b669" title="foedus::storage::PageHeader\l::get_in_layer_level" alt="" coords="441,239,632,281"/>
<area shape="rect" id="node12" href="structfoedus_1_1storage_1_1VolatilePagePointer.html#ac3d7cb1649528efa8b9aa22b63bf52e6" title="foedus::storage::Volatile\lPagePointer::get_offset" alt="" coords="456,605,617,646"/>
</map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_a86416af851cf44112fbc0ea9c519c9b9_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_a86416af851cf44112fbc0ea9c519c9b9_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_a86416af851cf44112fbc0ea9c519c9b9_icgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_a86416af851cf44112fbc0ea9c519c9b9_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1Composer.html#a0995635b97031b208127004382947acd" title="Drops volatile pages that have not been modified since the snapshotted epoch. " alt="" coords="205,39,384,80"/>
<area shape="rect" id="node3" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a26c51902174b692c91aedd15218f01b7" title="subroutine invoked by one thread for one node. " alt="" coords="432,31,616,87"/>
<area shape="rect" id="node4" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a5d474e7a6b4de127153103f2295cb0fa" title="Sub&#45;routine of handle_snapshot_triggered(). " alt="" coords="664,39,891,80"/>
<area shape="rect" id="node5" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a905ccf76fe0e076980dc1965f038fe10" title="handle_snapshot() calls this when it should start snapshotting. " alt="" coords="939,31,1149,87"/>
<area shape="rect" id="node6" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a64e3c7594b7d7d0d5f8a144bd802d910" title="Main routine for snapshot_thread_ in master engine. " alt="" coords="1197,5,1408,47"/>
<area shape="rect" id="node8" href="classfoedus_1_1restart_1_1RestartManagerPimpl.html#a8c5418a3e6d3558aa3920a605834df08" title="Recover the state of database from recent snapshot files and transaction logs. " alt="" coords="1225,71,1380,112"/>
<area shape="rect" id="node7" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a632a4da7b3c67dd687f7eba4f6ec1d76" title="foedus::snapshot::Snapshot\lManagerPimpl::initialize_once" alt="" coords="1456,5,1651,47"/>
<area shape="rect" id="node9" href="classfoedus_1_1restart_1_1RestartManagerPimpl.html#a868dca9015af77e04202ead68fd7a136" title="foedus::restart::Restart\lManagerPimpl::initialize_once" alt="" coords="1456,71,1651,112"/>
</map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a02f8d5682a453898cbae7ca4a4517094"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void foedus::storage::hash::HashComposer::launch_construct_root_multi_level </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html">HashComposer</a> *&#160;</td>
          <td class="paramname"><em>pointer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="group__STORAGE.html#structfoedus_1_1storage_1_1Composer_1_1ConstructRootArguments">Composer::ConstructRootArguments</a> *&#160;</td>
          <td class="paramname"><em>args</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>numa_node</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashIntermediatePage.html">HashIntermediatePage</a> *&#160;</td>
          <td class="paramname"><em>root_page</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classfoedus_1_1ErrorStack.html">ErrorStack</a> *&#160;</td>
          <td class="paramname"><em>out_error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>launched on its own thread. </p>

<p>Definition at line <a class="el" href="hash__composer__impl_8hpp_source.html#l00076">76</a> of file <a class="el" href="hash__composer__impl_8hpp_source.html">hash_composer_impl.hpp</a>.</p>

<p>Referenced by <a class="el" href="hash__composer__impl_8cpp_source.html#l00126">construct_root()</a>.</p>
<div class="fragment"><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                           {</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    *out_error = pointer-&gt;construct_root_multi_level(*args, numa_node, root_page);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  }</div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_a02f8d5682a453898cbae7ca4a4517094_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_a02f8d5682a453898cbae7ca4a4517094_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_a02f8d5682a453898cbae7ca4a4517094_icgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_a02f8d5682a453898cbae7ca4a4517094_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#ac5ad2e7fa792d58965a05be6bd43e43c" title="foedus::storage::hash\l::HashComposer::construct_root" alt="" coords="232,13,443,54"/>
<area shape="rect" id="node3" href="classfoedus_1_1storage_1_1Composer.html#adf148cbea7c8146dec88d23d2218452c" title="Construct root page(s) for one storage based on the ouputs of compose(). " alt="" coords="491,13,669,54"/>
</map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a641bbfa48a79b406ae30d8574184f0fd"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::string foedus::storage::hash::HashComposer::to_string </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="hash__composer__impl_8cpp_source.html#l00427">427</a> of file <a class="el" href="hash__composer__impl_8cpp_source.html">hash_composer_impl.cpp</a>.</p>

<p>Referenced by <a class="el" href="hash__composer__impl_8cpp_source.html#l00097">compose()</a>, and <a class="el" href="hash__composer__impl_8cpp_source.html#l00126">construct_root()</a>.</p>
<div class="fragment"><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                                        {</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="keywordflow">return</span> std::string(<span class="stringliteral">&quot;HashComposer-&quot;</span>) + std::to_string(storage_id_);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;}</div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1hash_1_1HashComposer_a641bbfa48a79b406ae30d8574184f0fd_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1hash_1_1HashComposer_a641bbfa48a79b406ae30d8574184f0fd_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1hash_1_1HashComposer_a641bbfa48a79b406ae30d8574184f0fd_icgraph" id="classfoedus_1_1storage_1_1hash_1_1HashComposer_a641bbfa48a79b406ae30d8574184f0fd_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#a31399ce4cdbe6c2e84fe02ac7f4f5a5e" title="foedus::storage::hash\l::HashComposer::compose" alt="" coords="246,5,426,47"/>
<area shape="rect" id="node4" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html#ac5ad2e7fa792d58965a05be6bd43e43c" title="foedus::storage::hash\l::HashComposer::construct_root" alt="" coords="231,71,441,112"/>
<area shape="rect" id="node3" href="classfoedus_1_1storage_1_1Composer.html#a28c752ec784b85418c0bfafab7ee60c0" title="Construct snapshot pages from sorted run files of one storage. " alt="" coords="489,5,668,47"/>
<area shape="rect" id="node5" href="classfoedus_1_1storage_1_1Composer.html#adf148cbea7c8146dec88d23d2218452c" title="Construct root page(s) for one storage based on the ouputs of compose(). " alt="" coords="489,71,668,112"/>
</map>
</div>
</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>/home/shino/foedus_code/foedus-core/include/foedus/storage/hash/<a class="el" href="hash__composer__impl_8hpp_source.html">hash_composer_impl.hpp</a></li>
<li>/home/shino/foedus_code/foedus-core/src/foedus/storage/hash/<a class="el" href="hash__composer__impl_8cpp_source.html">hash_composer_impl.cpp</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacefoedus.html">foedus</a></li><li class="navelem"><a class="el" href="namespacefoedus_1_1storage.html">storage</a></li><li class="navelem"><a class="el" href="namespacefoedus_1_1storage_1_1hash.html">hash</a></li><li class="navelem"><a class="el" href="classfoedus_1_1storage_1_1hash_1_1HashComposer.html">HashComposer</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
