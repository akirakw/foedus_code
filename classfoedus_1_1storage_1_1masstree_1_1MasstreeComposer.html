<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>libfoedus-core: foedus::storage::masstree::MasstreeComposer Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libfoedus-core
   </div>
   <div id="projectbrief">FOEDUS Core Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/centos7/"><span>Jenkins&#160;(x86_64&#160;Fedora)</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/ub1404/"><span>Jenkins&#160;(x86_64&#160;Ubuntu)</span></a></li>
      <li><a href="http://ms01915-003.hpl.hp.com:8080/"><span>Jenkins&#160;(aarch64&#160;Ubuntu)</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/tree/master"><span>Github</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/wiki"><span>Wiki</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">foedus::storage::masstree::MasstreeComposer Class Reference<span class="mlabels"><span class="mlabel">final</span></span><div class="ingroups"><a class="el" href="group__COMPONENTS.html">FOEDUS Components</a> &raquo; <a class="el" href="group__STORAGE.html">Storage Manager</a> &raquo; <a class="el" href="group__MASSTREE.html">Masstree Storage</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p><a class="el" href="classfoedus_1_1storage_1_1Composer.html" title="Represents a logic to compose a new version of data pages for one storage. ">Composer</a> for an masstree storage.  
 <a href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#details">More...</a></p>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p><a class="el" href="classfoedus_1_1storage_1_1Composer.html" title="Represents a logic to compose a new version of data pages for one storage. ">Composer</a> for an masstree storage. </p>
<p>This is the most complex composer out of the four storage types.</p>
<dl class="section user"><dt>Differences from volatile pages</dt><dd>There are a few fundamental differences from volatile world. <ul>
<li>Very high fill factor. Almost 100%. </li>
<li>No foster children. </li>
<li>All keys are completely sorted by keys in boundary pages, which speeds up cursor.</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Constructing pages that match volatile pages well</dt><dd>One of the differences from the simpler array storage is that page boundaries depend on the data. If the snapshot pages have all different page boundaries from volatile pages, the only snapshot pointer we can install after snapshotting is the root pointer. We can only drop the entire volatile pages in that case. In the current version, this <b>is</b> the case. We drop everything and we don't consider where's the page bounary in the volatile world. This is one of major todos. However, it should be just an implementation issue. "Peeking" the volatile world's page boundary is not a difficult thing especially because we don't care 100% accuracy; if the page boundary doesn't match occasionally, that's fine. We just use it to loosely guide the choice of page boundaries in snapshot pages.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>This is a private implementation-details of <a class="el" href="group__MASSTREE.html">Masstree Storage</a>, thus file name ends with _impl. Do not include this header from a client program. There is no case client program needs to access this internal class. </dd></dl>

<p>Definition at line <a class="el" href="masstree__composer__impl_8hpp_source.html#l00069">69</a> of file <a class="el" href="masstree__composer__impl_8hpp_source.html">masstree_composer_impl.hpp</a>.</p>
</div>
<p><code>#include &lt;<a class="el" href="masstree__composer__impl_8hpp_source.html">masstree_composer_impl.hpp</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a3153a40bfca82fe0eba9e44d4a719e32"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#a3153a40bfca82fe0eba9e44d4a719e32">MasstreeComposer</a> (<a class="el" href="classfoedus_1_1storage_1_1Composer.html">Composer</a> *parent)</td></tr>
<tr class="memdesc:a3153a40bfca82fe0eba9e44d4a719e32"><td class="mdescLeft">&#160;</td><td class="mdescRight"><a class="el" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html" title="Composer for an masstree storage. ">MasstreeComposer</a> methods.  <a href="#a3153a40bfca82fe0eba9e44d4a719e32">More...</a><br /></td></tr>
<tr class="separator:a3153a40bfca82fe0eba9e44d4a719e32"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab1264661a1f24383dcda1568f59425fe"><td class="memItemLeft" align="right" valign="top">std::string&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe">to_string</a> () const </td></tr>
<tr class="separator:ab1264661a1f24383dcda1568f59425fe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a05590cc1eeeb3aedd917276d19639fd1"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classfoedus_1_1ErrorStack.html">ErrorStack</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#a05590cc1eeeb3aedd917276d19639fd1">compose</a> (const <a class="el" href="group__STORAGE.html#structfoedus_1_1storage_1_1Composer_1_1ComposeArguments">Composer::ComposeArguments</a> &amp;args)</td></tr>
<tr class="separator:a05590cc1eeeb3aedd917276d19639fd1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a45eb1cba6ccf8f51c973030848a47a9d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classfoedus_1_1ErrorStack.html">ErrorStack</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#a45eb1cba6ccf8f51c973030848a47a9d">construct_root</a> (const <a class="el" href="group__STORAGE.html#structfoedus_1_1storage_1_1Composer_1_1ConstructRootArguments">Composer::ConstructRootArguments</a> &amp;args)</td></tr>
<tr class="separator:a45eb1cba6ccf8f51c973030848a47a9d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad25781d742feeced13ed8b047b485a3e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropResult.html">Composer::DropResult</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ad25781d742feeced13ed8b047b485a3e">drop_volatiles</a> (const <a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropVolatilesArguments.html">Composer::DropVolatilesArguments</a> &amp;args)</td></tr>
<tr class="memdesc:ad25781d742feeced13ed8b047b485a3e"><td class="mdescLeft">&#160;</td><td class="mdescRight">drop_volatiles and related methods  <a href="#ad25781d742feeced13ed8b047b485a3e">More...</a><br /></td></tr>
<tr class="separator:ad25781d742feeced13ed8b047b485a3e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa0cb9d19afa32166a7c128697f291ea2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#aa0cb9d19afa32166a7c128697f291ea2">drop_root_volatile</a> (const <a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropVolatilesArguments.html">Composer::DropVolatilesArguments</a> &amp;args)</td></tr>
<tr class="separator:aa0cb9d19afa32166a7c128697f291ea2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a3153a40bfca82fe0eba9e44d4a719e32"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">foedus::storage::masstree::MasstreeComposer::MasstreeComposer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classfoedus_1_1storage_1_1Composer.html">Composer</a> *&#160;</td>
          <td class="paramname"><em>parent</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">explicit</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p><a class="el" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html" title="Composer for an masstree storage. ">MasstreeComposer</a> methods. </p>

<p>Definition at line <a class="el" href="masstree__composer__impl_8cpp_source.html#l00071">71</a> of file <a class="el" href="masstree__composer__impl_8cpp_source.html">masstree_composer_impl.cpp</a>.</p>

<p>References <a class="el" href="assert__nd_8hpp_source.html#l00072">ASSERT_ND</a>, and <a class="el" href="storage_8hpp_source.html#l00169">foedus::storage::Storage&lt; CONTROL_BLOCK &gt;::exists()</a>.</p>
<div class="fragment"><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  : engine_(parent-&gt;get_engine()),</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    storage_id_(parent-&gt;get_storage_id()),</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    storage_(engine_, storage_id_) {</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(storage_.<a class="code" href="classfoedus_1_1storage_1_1Storage.html#ade24602975f3928e77762f8cb4da51ca">exists</a>());</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;}</div>
<div class="ttc" id="classfoedus_1_1storage_1_1Storage_html_ade24602975f3928e77762f8cb4da51ca"><div class="ttname"><a href="classfoedus_1_1storage_1_1Storage.html#ade24602975f3928e77762f8cb4da51ca">foedus::storage::Storage::exists</a></div><div class="ttdeci">bool exists() const </div><div class="ttdoc">Returns whether this storage is already created. </div><div class="ttdef"><b>Definition:</b> <a href="storage_8hpp_source.html#l00169">storage.hpp:169</a></div></div>
<div class="ttc" id="group__IDIOMS_html_gaa5c1d074da423c0f330d1bc8a098ecb8"><div class="ttname"><a href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a></div><div class="ttdeci">#define ASSERT_ND(x)</div><div class="ttdoc">A warning-free wrapper macro of assert() that has no performance effect in release mode even when &#39;x&#39;...</div><div class="ttdef"><b>Definition:</b> <a href="assert__nd_8hpp_source.html#l00072">assert_nd.hpp:72</a></div></div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a3153a40bfca82fe0eba9e44d4a719e32_cgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a3153a40bfca82fe0eba9e44d4a719e32_cgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a3153a40bfca82fe0eba9e44d4a719e32_cgraph" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a3153a40bfca82fe0eba9e44d4a719e32_cgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1Storage.html#ade24602975f3928e77762f8cb4da51ca" title="Returns whether this storage is already created. " alt="" coords="317,5,481,47"/>
</map>
</div>
</p>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a class="anchor" id="a05590cc1eeeb3aedd917276d19639fd1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classfoedus_1_1ErrorStack.html">ErrorStack</a> foedus::storage::masstree::MasstreeComposer::compose </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="group__STORAGE.html#structfoedus_1_1storage_1_1Composer_1_1ComposeArguments">Composer::ComposeArguments</a> &amp;&#160;</td>
          <td class="paramname"><em>args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="masstree__composer__impl_8cpp_source.html#l00078">78</a> of file <a class="el" href="masstree__composer__impl_8cpp_source.html">masstree_composer_impl.cpp</a>.</p>

<p>References <a class="el" href="composer_8hpp_source.html#l00110">foedus::storage::Composer::ComposeArguments::base_epoch_</a>, <a class="el" href="error__stack_8hpp_source.html#l00517">CHECK_ERROR</a>, <a class="el" href="stop__watch_8hpp_source.html#l00048">foedus::debugging::StopWatch::elapsed_ms()</a>, <a class="el" href="initializable_8hpp_source.html#l00169">foedus::DefaultInitializable::initialize()</a>, <a class="el" href="storage__id_8hpp_source.html#l00130">foedus::storage::kMasstreeStorage</a>, <a class="el" href="masstree__composer__impl_8hpp_source.html#l00165">foedus::storage::masstree::MasstreeComposeContext::kMaxLevels</a>, <a class="el" href="error__stack_8hpp_source.html#l00251">foedus::kRetOk</a>, <a class="el" href="composer_8hpp_source.html#l00101">foedus::storage::Composer::ComposeArguments::log_streams_</a>, <a class="el" href="composer_8hpp_source.html#l00103">foedus::storage::Composer::ComposeArguments::log_streams_count_</a>, <a class="el" href="stop__watch_8cpp_source.html#l00035">foedus::debugging::StopWatch::stop()</a>, <a class="el" href="masstree__composer__impl_8cpp_source.html#l00282">to_string()</a>, <a class="el" href="initializable_8hpp_source.html#l00187">foedus::DefaultInitializable::uninitialize()</a>, and <a class="el" href="composer_8hpp_source.html#l00105">foedus::storage::Composer::ComposeArguments::work_memory_</a>.</p>

<p>Referenced by <a class="el" href="composer_8cpp_source.html#l00061">foedus::storage::Composer::compose()</a>.</p>
<div class="fragment"><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;                                                                         {</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  VLOG(0) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; composing with &quot;</span> &lt;&lt; args.log_streams_count_ &lt;&lt; <span class="stringliteral">&quot; streams.&quot;</span>;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  debugging::StopWatch stop_watch;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  snapshot::MergeSort merge_sort(</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    storage_id_,</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <a class="code" href="group__STORAGE.html#gga016025043f5ef9c02be03f2f2a17a0dea132b35d3a56bd101207d58348d70bf9e">kMasstreeStorage</a>,</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    args.base_epoch_,</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    args.log_streams_,</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    args.log_streams_count_,</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <a class="code" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposeContext.html#ad9e37c0eca7fb90f69f90588948234a9a5b7595b9f53e5f4284a62047395df12a">MasstreeComposeContext::kMaxLevels</a>,</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    args.work_memory_);</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(merge_sort.initialize());</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  MasstreeComposeContext context(engine_, &amp;merge_sort, args);</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(context.execute());</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(merge_sort.uninitialize());  <span class="comment">// no need for scoped release. its destructor is safe.</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  stop_watch.stop();</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  LOG(INFO) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; done in &quot;</span> &lt;&lt; stop_watch.elapsed_ms() &lt;&lt; <span class="stringliteral">&quot;ms.&quot;</span>;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="group__ERRORCODES.html#ga61f52cd33eb500d6997a91e704ace244">kRetOk</a>;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;}</div>
<div class="ttc" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_html_ab1264661a1f24383dcda1568f59425fe"><div class="ttname"><a href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe">foedus::storage::masstree::MasstreeComposer::to_string</a></div><div class="ttdeci">std::string to_string() const </div><div class="ttdef"><b>Definition:</b> <a href="masstree__composer__impl_8cpp_source.html#l00282">masstree_composer_impl.cpp:282</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposeContext_html_ad9e37c0eca7fb90f69f90588948234a9a5b7595b9f53e5f4284a62047395df12a"><div class="ttname"><a href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposeContext.html#ad9e37c0eca7fb90f69f90588948234a9a5b7595b9f53e5f4284a62047395df12a">foedus::storage::masstree::MasstreeComposeContext::kMaxLevels</a></div><div class="ttdoc">We assume the path wouldn&#39;t be this deep. </div><div class="ttdef"><b>Definition:</b> <a href="masstree__composer__impl_8hpp_source.html#l00165">masstree_composer_impl.hpp:165</a></div></div>
<div class="ttc" id="group__STORAGE_html_gga016025043f5ef9c02be03f2f2a17a0dea132b35d3a56bd101207d58348d70bf9e"><div class="ttname"><a href="group__STORAGE.html#gga016025043f5ef9c02be03f2f2a17a0dea132b35d3a56bd101207d58348d70bf9e">foedus::storage::kMasstreeStorage</a></div><div class="ttdoc">Masstree Storage </div><div class="ttdef"><b>Definition:</b> <a href="storage__id_8hpp_source.html#l00130">storage_id.hpp:130</a></div></div>
<div class="ttc" id="group__ERRORCODES_html_ga72a80915c3588aea09c053ab567e19c4"><div class="ttname"><a href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a></div><div class="ttdeci">#define CHECK_ERROR(x)</div><div class="ttdoc">This macro calls x and checks its returned value. </div><div class="ttdef"><b>Definition:</b> <a href="error__stack_8hpp_source.html#l00517">error_stack.hpp:517</a></div></div>
<div class="ttc" id="group__ERRORCODES_html_ga61f52cd33eb500d6997a91e704ace244"><div class="ttname"><a href="group__ERRORCODES.html#ga61f52cd33eb500d6997a91e704ace244">foedus::kRetOk</a></div><div class="ttdeci">const ErrorStack kRetOk</div><div class="ttdoc">Normal return value for no-error case. </div><div class="ttdef"><b>Definition:</b> <a href="error__stack_8hpp_source.html#l00251">error_stack.hpp:251</a></div></div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a05590cc1eeeb3aedd917276d19639fd1_cgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a05590cc1eeeb3aedd917276d19639fd1_cgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a05590cc1eeeb3aedd917276d19639fd1_cgraph" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a05590cc1eeeb3aedd917276d19639fd1_cgraph">
<area shape="rect" id="node2" href="classfoedus_1_1debugging_1_1StopWatch.html#ac8a42ba406ab38b098e27a19e6803638" title="foedus::debugging::\lStopWatch::elapsed_ms" alt="" coords="275,71,441,112"/>
<area shape="rect" id="node3" href="classfoedus_1_1DefaultInitializable.html#a22a0dc3bbbca682c3bc41eace9b6d1ff" title="Typical implementation of Initializable::initialize() that provides initialize&#45;once semantics..." alt="" coords="272,136,444,177"/>
<area shape="rect" id="node8" href="classfoedus_1_1debugging_1_1StopWatch.html#a2ee5315a0f6bf736a2a73b29b1709bd2" title="Take another current time tick. " alt="" coords="291,267,425,308"/>
<area shape="rect" id="node11" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe" title="foedus::storage::masstree\l::MasstreeComposer::to_string" alt="" coords="257,332,459,373"/>
<area shape="rect" id="node12" href="classfoedus_1_1DefaultInitializable.html#ab14b136a7d26f9f499ab9dc15a45a8cb" title="Typical implementation of Initializable::uninitialize() that provides uninitialize&#45;once semantics..." alt="" coords="272,201,444,243"/>
<area shape="rect" id="node4" href="classfoedus_1_1DefaultInitializable.html#ab8ae37e5f20f312f8b945fc40d3e0250" title="foedus::DefaultInitializable\l::initialize_once" alt="" coords="507,5,679,47"/>
<area shape="rect" id="node5" href="classfoedus_1_1ErrorStack.html#a9c7b3a8b3806ff623c7fb4a9db5cbeec" title="Returns if this return code is not kErrorCodeOk. " alt="" coords="527,71,658,112"/>
<area shape="rect" id="node6" href="classfoedus_1_1DefaultInitializable.html#a1abda1e84b8af8bd6916e52fd0a09f3e" title="Returns whether the object has been already initialized or not. " alt="" coords="507,136,679,177"/>
<area shape="rect" id="node7" href="classfoedus_1_1DefaultInitializable.html#a764be22ce1454279e7a7e78f4c8e380b" title="foedus::DefaultInitializable\l::uninitialize_once" alt="" coords="507,201,679,243"/>
<area shape="rect" id="node9" href="classfoedus_1_1debugging_1_1StopWatch.html#adacc2b7108e7b4df019cc79733050b8c" title="foedus::debugging::\lStopWatch::elapsed_ns" alt="" coords="512,267,673,308"/>
<area shape="rect" id="node10" href="namespacefoedus_1_1debugging.html#a35a786b0492e9799cb74359408079091" title="foedus::debugging::\lget_now_nanosec" alt="" coords="525,332,660,373"/>
</map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a05590cc1eeeb3aedd917276d19639fd1_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a05590cc1eeeb3aedd917276d19639fd1_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a05590cc1eeeb3aedd917276d19639fd1_icgraph" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a05590cc1eeeb3aedd917276d19639fd1_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1Composer.html#a28c752ec784b85418c0bfafab7ee60c0" title="Construct snapshot pages from sorted run files of one storage. " alt="" coords="257,5,436,47"/>
</map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a45eb1cba6ccf8f51c973030848a47a9d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classfoedus_1_1ErrorStack.html">ErrorStack</a> foedus::storage::masstree::MasstreeComposer::construct_root </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="group__STORAGE.html#structfoedus_1_1storage_1_1Composer_1_1ConstructRootArguments">Composer::ConstructRootArguments</a> &amp;&#160;</td>
          <td class="paramname"><em>args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="masstree__composer__impl_8cpp_source.html#l00111">111</a> of file <a class="el" href="masstree__composer__impl_8cpp_source.html">masstree_composer_impl.cpp</a>.</p>

<p>References <a class="el" href="assert__nd_8hpp_source.html#l00072">ASSERT_ND</a>, <a class="el" href="error__stack_8hpp_source.html#l00517">CHECK_ERROR</a>, <a class="el" href="snapshot__writer__impl_8hpp_source.html#l00135">foedus::snapshot::SnapshotWriter::dump_pages()</a>, <a class="el" href="stop__watch_8hpp_source.html#l00048">foedus::debugging::StopWatch::elapsed_ms()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00367">foedus::storage::masstree::MasstreeIntermediatePage::extract_separators_snapshot()</a>, <a class="el" href="masstree__composer__impl_8cpp_source.html#l00102">foedus::storage::masstree::from_this_snapshot()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00146">foedus::storage::masstree::MasstreePage::get_btree_level()</a>, <a class="el" href="attachable_8hpp_source.html#l00097">foedus::Attachable&lt; CONTROL_BLOCK &gt;::get_control_block()</a>, <a class="el" href="page_8hpp_source.html#l00336">foedus::storage::Page::get_header()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00148">foedus::storage::masstree::MasstreePage::get_key_count()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00322">foedus::storage::masstree::MasstreeIntermediatePage::get_minipage()</a>, <a class="el" href="snapshot__writer__impl_8hpp_source.html#l00115">foedus::snapshot::SnapshotWriter::get_next_page_id()</a>, <a class="el" href="snapshot__writer__impl_8hpp_source.html#l00102">foedus::snapshot::SnapshotWriter::get_page_base()</a>, <a class="el" href="page_8hpp_source.html#l00280">foedus::storage::PageHeader::get_page_type()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00073">foedus::storage::masstree::MasstreePage::header()</a>, <a class="el" href="masstree__page__impl_8cpp_source.html#l00146">foedus::storage::masstree::MasstreeBorderPage::initialize_snapshot_page()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00084">foedus::storage::masstree::MasstreePage::is_border()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l01067">foedus::storage::masstree::MasstreeIntermediatePointerIterator::is_valid()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00271">foedus::storage::masstree::MasstreeIntermediatePage::MiniPage::key_count_</a>, <a class="el" href="page_8hpp_source.html#l00049">foedus::storage::kMasstreeIntermediatePageType</a>, <a class="el" href="storage__id_8hpp_source.html#l00045">foedus::storage::kPageSize</a>, <a class="el" href="error__stack_8hpp_source.html#l00251">foedus::kRetOk</a>, <a class="el" href="page_8hpp_source.html#l00243">foedus::storage::PageHeader::masstree_in_layer_level_</a>, <a class="el" href="composer_8hpp_source.html#l00136">foedus::storage::Composer::ConstructRootArguments::new_root_page_pointer_</a>, <a class="el" href="page_8hpp_source.html#l00191">foedus::storage::PageHeader::page_id_</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00278">foedus::storage::masstree::MasstreeIntermediatePage::MiniPage::pointers_</a>, <a class="el" href="composer_8hpp_source.html#l00130">foedus::storage::Composer::ConstructRootArguments::root_info_pages_</a>, <a class="el" href="composer_8hpp_source.html#l00132">foedus::storage::Composer::ConstructRootArguments::root_info_pages_count_</a>, <a class="el" href="page_8hpp_source.html#l00211">foedus::storage::PageHeader::snapshot_</a>, <a class="el" href="storage__id_8hpp_source.html#l00307">foedus::storage::DualPagePointer::snapshot_pointer_</a>, <a class="el" href="composer_8hpp_source.html#l00126">foedus::storage::Composer::ConstructRootArguments::snapshot_writer_</a>, <a class="el" href="stop__watch_8cpp_source.html#l00035">foedus::debugging::StopWatch::stop()</a>, <a class="el" href="page_8hpp_source.html#l00196">foedus::storage::PageHeader::storage_id_</a>, <a class="el" href="masstree__composer__impl_8cpp_source.html#l00282">to_string()</a>, and <a class="el" href="error__stack_8hpp_source.html#l00533">WRAP_ERROR_CODE</a>.</p>

<p>Referenced by <a class="el" href="composer_8cpp_source.html#l00072">foedus::storage::Composer::construct_root()</a>.</p>
<div class="fragment"><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                                                                                      {</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(args.root_info_pages_count_ &gt; 0);</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  VLOG(0) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; combining &quot;</span> &lt;&lt; args.root_info_pages_count_ &lt;&lt; <span class="stringliteral">&quot; root page info.&quot;</span>;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  debugging::StopWatch stop_watch;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <a class="code" href="group__STORAGE.html#ga629d4b8103bfb83ef9c11b842a4fd398">SnapshotPagePointer</a> new_root_id = args.snapshot_writer_-&gt;get_next_page_id();</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  Page* new_root = args.snapshot_writer_-&gt;get_page_base();</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  std::memcpy(new_root, args.root_info_pages_[0], <a class="code" href="group__STORAGE.html#ga1a3c05fe1d44455fc3e761947c6e21e6">kPageSize</a>);  <span class="comment">// use the first one as base</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="keywordflow">if</span> (args.root_info_pages_count_ == 1U) {</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    VLOG(0) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; only 1 root info page, so we just use it as the new root.&quot;</span>;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="comment">// otherwise, we merge inputs from each reducer. because of how we design partitions,</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="comment">// the inputs are always intermediate pages with same partitioning. we just place new</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="comment">// pointers to children</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(check_buddies(args));</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="comment">// because of how we partition, B-tree levels might be unbalanced at the root of first layer.</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="comment">// thus, we take the max of btree-level here.</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    MasstreeIntermediatePage* base = <span class="keyword">reinterpret_cast&lt;</span>MasstreeIntermediatePage*<span class="keyword">&gt;</span>(new_root);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(!base-&gt;is_border());</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordflow">for</span> (uint16_t buddy = 1; buddy &lt; args.root_info_pages_count_; ++buddy) {</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;      <span class="keyword">const</span> MasstreeIntermediatePage* page</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        = <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span>MasstreeIntermediatePage*<span class="keyword">&gt;</span>(args.root_info_pages_[buddy]);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;      <span class="keywordflow">if</span> (page-&gt;get_btree_level() &gt; base-&gt;get_btree_level()) {</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;MasstreeStorage-&quot;</span> &lt;&lt; storage_id_ &lt;&lt; <span class="stringliteral">&quot; has an unbalanced depth in sub-tree&quot;</span>;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        base-&gt;header().masstree_in_layer_level_ = page-&gt;get_btree_level();</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      }</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    }</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    uint16_t updated_count = 0;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="keywordflow">for</span> (<a class="code" href="group__MASSTREE.html#ga6280f932bf17f1d9d4acc294ca984bee">SlotIndex</a> i = 0; i &lt;= base-&gt;get_key_count(); ++i) {</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;      MasstreeIntermediatePage::MiniPage&amp; base_mini = base-&gt;get_minipage(i);</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;      <span class="keywordflow">for</span> (<a class="code" href="group__MASSTREE.html#ga6280f932bf17f1d9d4acc294ca984bee">SlotIndex</a> j = 0; j &lt;= base_mini.key_count_; ++j) {</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <a class="code" href="group__STORAGE.html#ga629d4b8103bfb83ef9c11b842a4fd398">SnapshotPagePointer</a> base_pointer = base_mini.pointers_[j].snapshot_pointer_;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="namespacefoedus_1_1storage_1_1masstree.html#ad5bde8a81bd922e388c91d1aaeac1411">from_this_snapshot</a>(base_pointer, args)) {</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;          ++updated_count;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;          <span class="keywordflow">continue</span>;  <span class="comment">// base has updated it</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        }</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="keywordflow">for</span> (uint16_t buddy = 1; buddy &lt; args.root_info_pages_count_; ++buddy) {</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;          <span class="keyword">const</span> MasstreeIntermediatePage* page</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            = <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span>MasstreeIntermediatePage*<span class="keyword">&gt;</span>(args.root_info_pages_[buddy]);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;          <span class="keyword">const</span> MasstreeIntermediatePage::MiniPage&amp; mini = page-&gt;get_minipage(i);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;          <a class="code" href="group__STORAGE.html#ga629d4b8103bfb83ef9c11b842a4fd398">SnapshotPagePointer</a> pointer = mini.pointers_[j].snapshot_pointer_;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="namespacefoedus_1_1storage_1_1masstree.html#ad5bde8a81bd922e388c91d1aaeac1411">from_this_snapshot</a>(pointer, args)) {</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;            base_mini.pointers_[j].snapshot_pointer_ = pointer;  <span class="comment">// this buddy has updated it</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            ++updated_count;</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;          }</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        }</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;      }</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    }</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    VLOG(0) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; has &quot;</span> &lt;&lt; updated_count &lt;&lt; <span class="stringliteral">&quot; new pointers from root.&quot;</span>;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  }</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="comment">// In either case, some pointer might be null if that partition had no log record</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  <span class="comment">// and if this is an initial snapshot. Create a dummy page for them.</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  MasstreeIntermediatePage* merged = <span class="keyword">reinterpret_cast&lt;</span>MasstreeIntermediatePage*<span class="keyword">&gt;</span>(new_root);</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(!merged-&gt;is_border());</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  uint16_t dummy_count = 0;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <span class="keywordflow">for</span> (MasstreeIntermediatePointerIterator it(merged); it.is_valid(); it.next()) {</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    DualPagePointer&amp; pointer = merged-&gt;get_minipage(it.index_).pointers_[it.index_mini_];</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="keywordflow">if</span> (pointer.snapshot_pointer_ == 0) {</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;      <span class="comment">// this should happen only while an initial snapshot for this storage.</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;      <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(storage_.<a class="code" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">get_control_block</a>()-&gt;root_page_pointer_.snapshot_pointer_ == 0);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;      <a class="code" href="group__MASSTREE.html#ga556e8f0d5e02e78f3ddecd8f5b022bf6">KeySlice</a> low, high;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      merged-&gt;extract_separators_snapshot(it.index_, it.index_mini_, &amp;low, &amp;high);</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;      uint32_t offset = 1U + dummy_count;  <span class="comment">// +1 for new_root</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;      <a class="code" href="group__STORAGE.html#ga629d4b8103bfb83ef9c11b842a4fd398">SnapshotPagePointer</a> page_id = args.snapshot_writer_-&gt;get_next_page_id() + offset;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      MasstreeBorderPage* dummy = <span class="keyword">reinterpret_cast&lt;</span>MasstreeBorderPage*<span class="keyword">&gt;</span>(</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        args.snapshot_writer_-&gt;get_page_base() + offset);</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      dummy-&gt;initialize_snapshot_page(storage_id_, page_id, 0, low, high);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;      pointer.snapshot_pointer_ = page_id;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;      ++dummy_count;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    }</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  }</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  VLOG(0) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; has added &quot;</span> &lt;&lt; dummy_count &lt;&lt; <span class="stringliteral">&quot; dummy pointers in root.&quot;</span>;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(new_root-&gt;get_header().snapshot_);</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(new_root-&gt;get_header().storage_id_ == storage_id_);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(new_root-&gt;get_header().get_page_type() == <a class="code" href="group__STORAGE.html#gga14e35f7fbe4bc18276fde8e8ba460f5ba23ef27cc0a436fe010a22a7374e8737b">kMasstreeIntermediatePageType</a>);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  new_root-&gt;get_header().page_id_ = new_root_id;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  *args.new_root_page_pointer_ = new_root_id;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <a class="code" href="group__ERRORCODES.html#ga952ce4f5f860d7b28a70095b450d3f4d">WRAP_ERROR_CODE</a>(args.snapshot_writer_-&gt;dump_pages(0, 1 + dummy_count));</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <span class="comment">// AFTER writing out the root page, install the pointer to new root page</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  storage_.<a class="code" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">get_control_block</a>()-&gt;root_page_pointer_.snapshot_pointer_ = new_root_id;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  storage_.<a class="code" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">get_control_block</a>()-&gt;meta_.root_snapshot_page_id_ = new_root_id;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  stop_watch.stop();</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  VLOG(0) &lt;&lt; <a class="code" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe">to_string</a>() &lt;&lt; <span class="stringliteral">&quot; done in &quot;</span> &lt;&lt; stop_watch.elapsed_ms() &lt;&lt; <span class="stringliteral">&quot;ms.&quot;</span>;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="group__ERRORCODES.html#ga61f52cd33eb500d6997a91e704ace244">kRetOk</a>;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;}</div>
<div class="ttc" id="group__MASSTREE_html_ga6280f932bf17f1d9d4acc294ca984bee"><div class="ttname"><a href="group__MASSTREE.html#ga6280f932bf17f1d9d4acc294ca984bee">foedus::storage::masstree::SlotIndex</a></div><div class="ttdeci">uint16_t SlotIndex</div><div class="ttdoc">Index of a record in a (border) page. </div><div class="ttdef"><b>Definition:</b> <a href="masstree__id_8hpp_source.html#l00110">masstree_id.hpp:110</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_html_ab1264661a1f24383dcda1568f59425fe"><div class="ttname"><a href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe">foedus::storage::masstree::MasstreeComposer::to_string</a></div><div class="ttdeci">std::string to_string() const </div><div class="ttdef"><b>Definition:</b> <a href="masstree__composer__impl_8cpp_source.html#l00282">masstree_composer_impl.cpp:282</a></div></div>
<div class="ttc" id="group__MASSTREE_html_ga556e8f0d5e02e78f3ddecd8f5b022bf6"><div class="ttname"><a href="group__MASSTREE.html#ga556e8f0d5e02e78f3ddecd8f5b022bf6">foedus::storage::masstree::KeySlice</a></div><div class="ttdeci">uint64_t KeySlice</div><div class="ttdoc">Each key slice is an 8-byte integer. </div><div class="ttdef"><b>Definition:</b> <a href="masstree__id_8hpp_source.html#l00126">masstree_id.hpp:126</a></div></div>
<div class="ttc" id="group__STORAGE_html_ga629d4b8103bfb83ef9c11b842a4fd398"><div class="ttname"><a href="group__STORAGE.html#ga629d4b8103bfb83ef9c11b842a4fd398">foedus::storage::SnapshotPagePointer</a></div><div class="ttdeci">uint64_t SnapshotPagePointer</div><div class="ttdoc">Page ID of a snapshot page. </div><div class="ttdef"><b>Definition:</b> <a href="storage__id_8hpp_source.html#l00079">storage_id.hpp:79</a></div></div>
<div class="ttc" id="namespacefoedus_1_1storage_1_1masstree_html_ad5bde8a81bd922e388c91d1aaeac1411"><div class="ttname"><a href="namespacefoedus_1_1storage_1_1masstree.html#ad5bde8a81bd922e388c91d1aaeac1411">foedus::storage::masstree::from_this_snapshot</a></div><div class="ttdeci">bool from_this_snapshot(SnapshotPagePointer pointer, const Composer::ConstructRootArguments &amp;args)</div><div class="ttdef"><b>Definition:</b> <a href="masstree__composer__impl_8cpp_source.html#l00102">masstree_composer_impl.cpp:102</a></div></div>
<div class="ttc" id="group__ERRORCODES_html_ga72a80915c3588aea09c053ab567e19c4"><div class="ttname"><a href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a></div><div class="ttdeci">#define CHECK_ERROR(x)</div><div class="ttdoc">This macro calls x and checks its returned value. </div><div class="ttdef"><b>Definition:</b> <a href="error__stack_8hpp_source.html#l00517">error_stack.hpp:517</a></div></div>
<div class="ttc" id="group__ERRORCODES_html_ga61f52cd33eb500d6997a91e704ace244"><div class="ttname"><a href="group__ERRORCODES.html#ga61f52cd33eb500d6997a91e704ace244">foedus::kRetOk</a></div><div class="ttdeci">const ErrorStack kRetOk</div><div class="ttdoc">Normal return value for no-error case. </div><div class="ttdef"><b>Definition:</b> <a href="error__stack_8hpp_source.html#l00251">error_stack.hpp:251</a></div></div>
<div class="ttc" id="group__STORAGE_html_gga14e35f7fbe4bc18276fde8e8ba460f5ba23ef27cc0a436fe010a22a7374e8737b"><div class="ttname"><a href="group__STORAGE.html#gga14e35f7fbe4bc18276fde8e8ba460f5ba23ef27cc0a436fe010a22a7374e8737b">foedus::storage::kMasstreeIntermediatePageType</a></div><div class="ttdef"><b>Definition:</b> <a href="page_8hpp_source.html#l00049">page.hpp:49</a></div></div>
<div class="ttc" id="group__IDIOMS_html_gaa5c1d074da423c0f330d1bc8a098ecb8"><div class="ttname"><a href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a></div><div class="ttdeci">#define ASSERT_ND(x)</div><div class="ttdoc">A warning-free wrapper macro of assert() that has no performance effect in release mode even when &#39;x&#39;...</div><div class="ttdef"><b>Definition:</b> <a href="assert__nd_8hpp_source.html#l00072">assert_nd.hpp:72</a></div></div>
<div class="ttc" id="group__ERRORCODES_html_ga952ce4f5f860d7b28a70095b450d3f4d"><div class="ttname"><a href="group__ERRORCODES.html#ga952ce4f5f860d7b28a70095b450d3f4d">WRAP_ERROR_CODE</a></div><div class="ttdeci">#define WRAP_ERROR_CODE(x)</div><div class="ttdoc">Same as CHECK_ERROR(x) except it receives only an error code, thus more efficient. </div><div class="ttdef"><b>Definition:</b> <a href="error__stack_8hpp_source.html#l00533">error_stack.hpp:533</a></div></div>
<div class="ttc" id="classfoedus_1_1Attachable_html_a5b324e3abf302a59801aa73419bb4fad"><div class="ttname"><a href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">foedus::Attachable::get_control_block</a></div><div class="ttdeci">CONTROL_BLOCK * get_control_block() const </div><div class="ttdef"><b>Definition:</b> <a href="attachable_8hpp_source.html#l00097">attachable.hpp:97</a></div></div>
<div class="ttc" id="group__STORAGE_html_ga1a3c05fe1d44455fc3e761947c6e21e6"><div class="ttname"><a href="group__STORAGE.html#ga1a3c05fe1d44455fc3e761947c6e21e6">foedus::storage::kPageSize</a></div><div class="ttdeci">const uint16_t kPageSize</div><div class="ttdoc">A constant defining the page size (in bytes) of both snapshot pages and volatile pages. </div><div class="ttdef"><b>Definition:</b> <a href="storage__id_8hpp_source.html#l00045">storage_id.hpp:45</a></div></div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a45eb1cba6ccf8f51c973030848a47a9d_cgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a45eb1cba6ccf8f51c973030848a47a9d_cgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a45eb1cba6ccf8f51c973030848a47a9d_cgraph" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a45eb1cba6ccf8f51c973030848a47a9d_cgraph">
<area shape="rect" id="node2" href="classfoedus_1_1snapshot_1_1SnapshotWriter.html#a55ba9fc4a87f71b3991bba1c39948cc9" title="Write out pages that are contiguous in the main page pool. " alt="" coords="300,21,484,63"/>
<area shape="rect" id="node3" href="classfoedus_1_1debugging_1_1StopWatch.html#ac8a42ba406ab38b098e27a19e6803638" title="foedus::debugging::\lStopWatch::elapsed_ms" alt="" coords="309,87,475,128"/>
<area shape="rect" id="node4" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeIntermediatePage.html#aa64c68858f06b2665809772e26e385c1" title="Retrieves separators defining the index, used only by snapshot composer, thus no race. " alt="" coords="293,203,491,259"/>
<area shape="rect" id="node6" href="classfoedus_1_1storage_1_1masstree_1_1MasstreePage.html#a1a6f55a5a59bcab9631bbb879da689ec" title="foedus::storage::masstree\l::MasstreePage::is_border" alt="" coords="845,5,1020,47"/>
<area shape="rect" id="node7" href="structfoedus_1_1storage_1_1PageHeader.html#a1bdd725342fd4aa90f983fec651f6956" title="foedus::storage::PageHeader\l::get_page_type" alt="" coords="1089,141,1280,183"/>
<area shape="rect" id="node8" href="classfoedus_1_1storage_1_1masstree_1_1MasstreePage.html#a3ab3ec4aa9b6e43a606e1555c5c74cec" title="physical key count (those keys might be deleted) in this page. " alt="" coords="829,651,1036,692"/>
<area shape="rect" id="node9" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeIntermediatePage.html#a1cb83de15afc0a903046937276b0ed31" title="foedus::storage::masstree\l::MasstreeIntermediatePage\l::get_minipage" alt="" coords="840,334,1025,390"/>
<area shape="rect" id="node13" href="namespacefoedus_1_1storage_1_1masstree.html#ad5bde8a81bd922e388c91d1aaeac1411" title="foedus::storage::masstree\l::from_this_snapshot" alt="" coords="305,436,479,477"/>
<area shape="rect" id="node16" href="classfoedus_1_1storage_1_1masstree_1_1MasstreePage.html#ab55e48873dcf5700871a035c65bfa588" title="used only in masstree. " alt="" coords="288,501,496,543"/>
<area shape="rect" id="node17" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad" title="foedus::Attachable\l::get_control_block" alt="" coords="326,567,458,608"/>
<area shape="rect" id="node18" href="structfoedus_1_1storage_1_1Page.html#abee44ea141b30e613f3de40831d6ff8e" title="At least the basic header exists in all pages. " alt="" coords="317,632,467,673"/>
<area shape="rect" id="node19" href="classfoedus_1_1snapshot_1_1SnapshotWriter.html#af9bcb8a605aecbbc3eabdc6664f6b163" title="foedus::snapshot::Snapshot\lWriter::get_next_page_id" alt="" coords="300,697,484,739"/>
<area shape="rect" id="node20" href="classfoedus_1_1snapshot_1_1SnapshotWriter.html#a4f72263ae71f34fad0130151328d6720" title="foedus::snapshot::Snapshot\lWriter::get_page_base" alt="" coords="300,763,484,804"/>
<area shape="rect" id="node22" href="classfoedus_1_1storage_1_1masstree_1_1MasstreePage.html#ab5ab7bbce35893143d2aac437e526d0e" title="foedus::storage::masstree\l::MasstreePage::header" alt="" coords="305,828,479,869"/>
<area shape="rect" id="node23" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeBorderPage.html#a2f1e35c48bba8f7c8319d5739487768d" title="foedus::storage::masstree\l::MasstreeBorderPage::initialize\l_snapshot_page" alt="" coords="289,945,495,1001"/>
<area shape="rect" id="node32" href="structfoedus_1_1storage_1_1masstree_1_1MasstreeIntermediatePointerIterator.html#acd0b166a127ed5fbadecd838f8e32be5" title="foedus::storage::masstree\l::MasstreeIntermediatePointerIterator\l::is_valid" alt="" coords="544,385,780,441"/>
<area shape="rect" id="node33" href="classfoedus_1_1debugging_1_1StopWatch.html#a2ee5315a0f6bf736a2a73b29b1709bd2" title="Take another current time tick. " alt="" coords="325,1025,459,1067"/>
<area shape="rect" id="node36" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#ab1264661a1f24383dcda1568f59425fe" title="foedus::storage::masstree\l::MasstreeComposer::to_string" alt="" coords="291,1091,493,1132"/>
<area shape="rect" id="node5" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeIntermediatePage.html#a7b5848c6b2be269bf90d1d5e41e66a33" title="Retrieves separators defining the index, used only by snapshot composer (or when no race) ..." alt="" coords="565,203,759,259"/>
<area shape="rect" id="node10" href="classfoedus_1_1storage_1_1masstree_1_1MasstreePage.html#a30f922c414bf3a2faaf7e879b2277f0b" title="foedus::storage::masstree\l::MasstreePage::get_low_fence" alt="" coords="831,71,1035,112"/>
<area shape="rect" id="node11" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeIntermediatePage.html#adaf1febd2954da507ffd8daa2757c890" title="foedus::storage::masstree\l::MasstreeIntermediatePage\l::get_separator" alt="" coords="840,137,1025,193"/>
<area shape="rect" id="node12" href="classfoedus_1_1storage_1_1masstree_1_1MasstreePage.html#abb6557473edd899373ed9399b455be20" title="foedus::storage::masstree\l::MasstreePage::get_high_fence" alt="" coords="828,217,1037,259"/>
<area shape="rect" id="node14" href="namespacefoedus_1_1storage.html#a82df0b3921d7c863275baf4f9c59959c" title="foedus::storage::extract\l_snapshot_id_from_snapshot\l_pointer" alt="" coords="567,465,757,521"/>
<area shape="rect" id="node15" href="classfoedus_1_1snapshot_1_1SnapshotWriter.html#ad4209f06409d52c010aac8bf98660dbe" title="foedus::snapshot::Snapshot\lWriter::get_snapshot_id" alt="" coords="570,545,754,587"/>
<area shape="rect" id="node21" href="classfoedus_1_1memory_1_1AlignedMemory.html#af306ba60622e2a87f75ae93dc6c597b1" title="Returns the memory block. " alt="" coords="555,763,769,804"/>
<area shape="rect" id="node24" href="classfoedus_1_1storage_1_1masstree_1_1MasstreePage.html#ab41ee4ce455995cd703dac3990442081" title="foedus::storage::masstree\l::MasstreePage::initialize\l_snapshot_common" alt="" coords="575,945,749,1001"/>
<area shape="rect" id="node25" href="structfoedus_1_1storage_1_1PageHeader.html#a65c4acd213d2f482eb29c6dee0818915" title="foedus::storage::PageHeader\l::init_snapshot" alt="" coords="837,952,1028,993"/>
<area shape="rect" id="node26" href="namespacefoedus_1_1storage.html#a8f6e96ac10eb804602349a54292d26a1" title="foedus::storage::extract\l_numa_node_from_snapshot\l_pointer" alt="" coords="1091,871,1279,927"/>
<area shape="rect" id="node27" href="structfoedus_1_1assorted_1_1ProbCounter.html#a8e7b31f9a6b4997f6c0916f7e20d755a" title="foedus::assorted::ProbCounter\l::reset" alt="" coords="1085,952,1284,993"/>
<area shape="rect" id="node28" href="structfoedus_1_1storage_1_1PageVersion.html#ae40168c82f16645e85bb66f9019e53cf" title="used only while page initialization " alt="" coords="1089,1017,1281,1059"/>
<area shape="rect" id="node29" href="structfoedus_1_1storage_1_1PageVersionStatus.html#af49ef4f3320148130f46f494f1c845aa" title="foedus::storage::PageVersion\lStatus::reset" alt="" coords="1332,984,1524,1025"/>
<area shape="rect" id="node30" href="structfoedus_1_1xct_1_1McsWwLock.html#a4114c2dec151ad650a294dedac4f239d" title="used only while page initialization " alt="" coords="1343,1049,1513,1091"/>
<area shape="rect" id="node31" href="structfoedus_1_1xct_1_1McsWwBlockData.html#a3161e47c41388e9c1b50929f585e366b" title="foedus::xct::McsWwBlockData\l::clear" alt="" coords="1572,1049,1773,1091"/>
<area shape="rect" id="node34" href="classfoedus_1_1debugging_1_1StopWatch.html#adacc2b7108e7b4df019cc79733050b8c" title="foedus::debugging::\lStopWatch::elapsed_ns" alt="" coords="581,1025,743,1067"/>
<area shape="rect" id="node35" href="namespacefoedus_1_1debugging.html#a35a786b0492e9799cb74359408079091" title="foedus::debugging::\lget_now_nanosec" alt="" coords="595,1091,729,1132"/>
</map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a45eb1cba6ccf8f51c973030848a47a9d_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a45eb1cba6ccf8f51c973030848a47a9d_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a45eb1cba6ccf8f51c973030848a47a9d_icgraph" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_a45eb1cba6ccf8f51c973030848a47a9d_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1Composer.html#adf148cbea7c8146dec88d23d2218452c" title="Construct root page(s) for one storage based on the ouputs of compose(). " alt="" coords="288,5,467,47"/>
</map>
</div>
</p>

</div>
</div>
<a class="anchor" id="aa0cb9d19afa32166a7c128697f291ea2"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void foedus::storage::masstree::MasstreeComposer::drop_root_volatile </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropVolatilesArguments.html">Composer::DropVolatilesArguments</a> &amp;&#160;</td>
          <td class="paramname"><em>args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="masstree__composer__impl_8cpp_source.html#l02622">2622</a> of file <a class="el" href="masstree__composer__impl_8cpp_source.html">masstree_composer_impl.cpp</a>.</p>

<p>References <a class="el" href="storage__id_8hpp_source.html#l00211">foedus::storage::VolatilePagePointer::clear()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00146">foedus::storage::masstree::MasstreePage::get_btree_level()</a>, <a class="el" href="attachable_8hpp_source.html#l00097">foedus::Attachable&lt; CONTROL_BLOCK &gt;::get_control_block()</a>, <a class="el" href="masstree__storage_8cpp_source.html#l00059">foedus::storage::masstree::MasstreeStorage::get_masstree_metadata()</a>, <a class="el" href="storage_8hpp_source.html#l00155">foedus::storage::Storage&lt; CONTROL_BLOCK &gt;::get_name()</a>, <a class="el" href="metadata_8hpp_source.html#l00098">foedus::storage::Metadata::keeps_all_volatile_pages()</a>, and <a class="el" href="storage__id_8hpp_source.html#l00308">foedus::storage::DualPagePointer::volatile_pointer_</a>.</p>

<p>Referenced by <a class="el" href="composer_8cpp_source.html#l00094">foedus::storage::Composer::drop_root_volatile()</a>.</p>
<div class="fragment"><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;                                                                                    {</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;  <span class="keywordflow">if</span> (storage_.<a class="code" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeStorage.html#a94bc2a1ae36c0a1ce1de99715072c59d">get_masstree_metadata</a>()-&gt;<a class="code" href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b">keeps_all_volatile_pages</a>()) {</div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Oh, but keep-all-volatile is on. Storage-&quot;</span> &lt;&lt; storage_.<a class="code" href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01">get_name</a>()</div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;      &lt;&lt; <span class="stringliteral">&quot; is configured to keep all volatile pages.&quot;</span>;</div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;  }</div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;  DualPagePointer* root_pointer = &amp;storage_.<a class="code" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">get_control_block</a>()-&gt;root_page_pointer_;</div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;  MasstreeIntermediatePage* volatile_page = <span class="keyword">reinterpret_cast&lt;</span>MasstreeIntermediatePage*<span class="keyword">&gt;</span>(</div>
<div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;    resolve_volatile(root_pointer-&gt;volatile_pointer_));</div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;  <span class="keywordflow">if</span> (volatile_page == <span class="keyword">nullptr</span>) {</div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Oh, but root volatile page already null&quot;</span>;</div>
<div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;  }</div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;</div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;  <span class="keywordflow">if</span> (is_to_keep_volatile(0, volatile_page-&gt;get_btree_level())) {</div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Oh, but &quot;</span> &lt;&lt; storage_ &lt;&lt; <span class="stringliteral">&quot; is configured to keep the root page.&quot;</span>;</div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;  }</div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;</div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;  <span class="comment">// yes, we can drop ALL volatile pages!</span></div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;  LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Okay, drop em all!!&quot;</span>;</div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;  drop_all_recurse(args, root_pointer);</div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;  root_pointer-&gt;volatile_pointer_.clear();</div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;}</div>
<div class="ttc" id="structfoedus_1_1storage_1_1Metadata_html_a675df0db1a3c909581db949c10fd192b"><div class="ttname"><a href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b">foedus::storage::Metadata::keeps_all_volatile_pages</a></div><div class="ttdeci">bool keeps_all_volatile_pages() const </div><div class="ttdef"><b>Definition:</b> <a href="metadata_8hpp_source.html#l00098">metadata.hpp:98</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1Storage_html_ac1b54d4e7f3ad9f7f7c17598911abb01"><div class="ttname"><a href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01">foedus::storage::Storage::get_name</a></div><div class="ttdeci">const StorageName &amp; get_name() const </div><div class="ttdoc">Returns the unique name of this storage. </div><div class="ttdef"><b>Definition:</b> <a href="storage_8hpp_source.html#l00155">storage.hpp:155</a></div></div>
<div class="ttc" id="classfoedus_1_1Attachable_html_a5b324e3abf302a59801aa73419bb4fad"><div class="ttname"><a href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">foedus::Attachable::get_control_block</a></div><div class="ttdeci">CONTROL_BLOCK * get_control_block() const </div><div class="ttdef"><b>Definition:</b> <a href="attachable_8hpp_source.html#l00097">attachable.hpp:97</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeStorage_html_a94bc2a1ae36c0a1ce1de99715072c59d"><div class="ttname"><a href="classfoedus_1_1storage_1_1masstree_1_1MasstreeStorage.html#a94bc2a1ae36c0a1ce1de99715072c59d">foedus::storage::masstree::MasstreeStorage::get_masstree_metadata</a></div><div class="ttdeci">const MasstreeMetadata * get_masstree_metadata() const </div><div class="ttdef"><b>Definition:</b> <a href="masstree__storage_8cpp_source.html#l00059">masstree_storage.cpp:59</a></div></div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_aa0cb9d19afa32166a7c128697f291ea2_cgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_aa0cb9d19afa32166a7c128697f291ea2_cgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_aa0cb9d19afa32166a7c128697f291ea2_cgraph" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_aa0cb9d19afa32166a7c128697f291ea2_cgraph">
<area shape="rect" id="node2" href="structfoedus_1_1storage_1_1VolatilePagePointer.html#aa8c59b8e2944d4a6a68d5fed840a7a29" title="foedus::storage::Volatile\lPagePointer::clear" alt="" coords="253,5,414,47"/>
<area shape="rect" id="node3" href="classfoedus_1_1storage_1_1masstree_1_1MasstreePage.html#ab55e48873dcf5700871a035c65bfa588" title="used only in masstree. " alt="" coords="229,71,437,112"/>
<area shape="rect" id="node4" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad" title="foedus::Attachable\l::get_control_block" alt="" coords="267,136,399,177"/>
<area shape="rect" id="node5" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeStorage.html#a94bc2a1ae36c0a1ce1de99715072c59d" title="foedus::storage::masstree\l::MasstreeStorage::get\l_masstree_metadata" alt="" coords="247,202,420,258"/>
<area shape="rect" id="node6" href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01" title="Returns the unique name of this storage. " alt="" coords="251,283,415,324"/>
<area shape="rect" id="node7" href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b" title="foedus::storage::Metadata\l::keeps_all_volatile_pages" alt="" coords="247,348,420,389"/>
</map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_aa0cb9d19afa32166a7c128697f291ea2_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_aa0cb9d19afa32166a7c128697f291ea2_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_aa0cb9d19afa32166a7c128697f291ea2_icgraph" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_aa0cb9d19afa32166a7c128697f291ea2_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1Composer.html#af6d90399f471e1461fd4e59b0f3b923f" title="This is additionally called when no partitions observed any new modifications. " alt="" coords="229,39,408,80"/>
<area shape="rect" id="node3" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a5d474e7a6b4de127153103f2295cb0fa" title="Sub&#45;routine of handle_snapshot_triggered(). " alt="" coords="456,39,683,80"/>
<area shape="rect" id="node4" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a905ccf76fe0e076980dc1965f038fe10" title="handle_snapshot() calls this when it should start snapshotting. " alt="" coords="731,31,941,87"/>
<area shape="rect" id="node5" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a64e3c7594b7d7d0d5f8a144bd802d910" title="Main routine for snapshot_thread_ in master engine. " alt="" coords="989,5,1200,47"/>
<area shape="rect" id="node7" href="classfoedus_1_1restart_1_1RestartManagerPimpl.html#a8c5418a3e6d3558aa3920a605834df08" title="Recover the state of database from recent snapshot files and transaction logs. " alt="" coords="1017,71,1172,112"/>
<area shape="rect" id="node6" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a632a4da7b3c67dd687f7eba4f6ec1d76" title="foedus::snapshot::Snapshot\lManagerPimpl::initialize_once" alt="" coords="1248,5,1443,47"/>
<area shape="rect" id="node8" href="classfoedus_1_1restart_1_1RestartManagerPimpl.html#a868dca9015af77e04202ead68fd7a136" title="foedus::restart::Restart\lManagerPimpl::initialize_once" alt="" coords="1248,71,1443,112"/>
</map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ad25781d742feeced13ed8b047b485a3e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropResult.html">Composer::DropResult</a> foedus::storage::masstree::MasstreeComposer::drop_volatiles </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structfoedus_1_1storage_1_1Composer_1_1DropVolatilesArguments.html">Composer::DropVolatilesArguments</a> &amp;&#160;</td>
          <td class="paramname"><em>args</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>drop_volatiles and related methods </p>

<p>Definition at line <a class="el" href="masstree__composer__impl_8cpp_source.html#l02558">2558</a> of file <a class="el" href="masstree__composer__impl_8cpp_source.html">masstree_composer_impl.cpp</a>.</p>

<p>References <a class="el" href="assert__nd_8hpp_source.html#l00072">ASSERT_ND</a>, <a class="el" href="composer_8hpp_source.html#l00176">foedus::storage::Composer::DropResult::combine()</a>, <a class="el" href="composer_8hpp_source.html#l00202">foedus::storage::Composer::DropResult::dropped_all_</a>, <a class="el" href="attachable_8hpp_source.html#l00097">foedus::Attachable&lt; CONTROL_BLOCK &gt;::get_control_block()</a>, <a class="el" href="masstree__storage_8cpp_source.html#l00059">foedus::storage::masstree::MasstreeStorage::get_masstree_metadata()</a>, <a class="el" href="partitioner_8cpp_source.html#l00038">foedus::storage::PartitionerMetadata::get_metadata()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00322">foedus::storage::masstree::MasstreeIntermediatePage::get_minipage()</a>, <a class="el" href="storage_8hpp_source.html#l00155">foedus::storage::Storage&lt; CONTROL_BLOCK &gt;::get_name()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l01067">foedus::storage::masstree::MasstreeIntermediatePointerIterator::is_valid()</a>, <a class="el" href="metadata_8hpp_source.html#l00098">foedus::storage::Metadata::keeps_all_volatile_pages()</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00251">foedus::storage::masstree::kMaxIntermediatePointers</a>, <a class="el" href="masstree__id_8hpp_source.html#l00137">foedus::storage::masstree::kSupremumSlice</a>, <a class="el" href="partitioner_8cpp_source.html#l00051">foedus::storage::PartitionerMetadata::locate_data()</a>, <a class="el" href="masstree__partitioner__impl_8hpp_source.html#l00147">foedus::storage::masstree::MasstreePartitionerData::low_keys_</a>, <a class="el" href="composer_8hpp_source.html#l00152">foedus::storage::Composer::DropVolatilesArguments::my_partition_</a>, <a class="el" href="masstree__partitioner__impl_8hpp_source.html#l00146">foedus::storage::masstree::MasstreePartitionerData::partition_count_</a>, <a class="el" href="composer_8hpp_source.html#l00154">foedus::storage::Composer::DropVolatilesArguments::partitioned_drop_</a>, <a class="el" href="masstree__partitioner__impl_8hpp_source.html#l00148">foedus::storage::masstree::MasstreePartitionerData::partitions_</a>, <a class="el" href="masstree__page__impl_8hpp_source.html#l00278">foedus::storage::masstree::MasstreeIntermediatePage::MiniPage::pointers_</a>, <a class="el" href="partitioner_8hpp_source.html#l00237">foedus::storage::PartitionerMetadata::valid_</a>, and <a class="el" href="storage__id_8hpp_source.html#l00308">foedus::storage::DualPagePointer::volatile_pointer_</a>.</p>

<p>Referenced by <a class="el" href="composer_8cpp_source.html#l00083">foedus::storage::Composer::drop_volatiles()</a>.</p>
<div class="fragment"><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;                                              {</div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;  Composer::DropResult result(args);</div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;  <span class="keywordflow">if</span> (storage_.<a class="code" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeStorage.html#a94bc2a1ae36c0a1ce1de99715072c59d">get_masstree_metadata</a>()-&gt;<a class="code" href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b">keeps_all_volatile_pages</a>()) {</div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;Keep-all-volatile: Storage-&quot;</span> &lt;&lt; storage_.<a class="code" href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01">get_name</a>()</div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;      &lt;&lt; <span class="stringliteral">&quot; is configured to keep all volatile pages.&quot;</span>;</div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;    result.dropped_all_ = <span class="keyword">false</span>;</div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;    <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;  }</div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;</div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;  DualPagePointer* root_pointer = &amp;storage_.<a class="code" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">get_control_block</a>()-&gt;root_page_pointer_;</div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;  MasstreeIntermediatePage* volatile_page = <span class="keyword">reinterpret_cast&lt;</span>MasstreeIntermediatePage*<span class="keyword">&gt;</span>(</div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;    resolve_volatile(root_pointer-&gt;volatile_pointer_));</div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;  <span class="keywordflow">if</span> (volatile_page == <span class="keyword">nullptr</span>) {</div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;No volatile root page. Probably while restart&quot;</span>;</div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;    <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;  }</div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;</div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;  <span class="comment">// Unlike array-storage, each thread decides partititions to follow a bit differently</span></div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;  <span class="comment">// because the snapshot pointer might be not installed.</span></div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;  <span class="comment">// We check the partitioning assignment.</span></div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;  PartitionerMetadata* metadata = <a class="code" href="structfoedus_1_1storage_1_1PartitionerMetadata.html#aa6e48ddb92bb1c1b572cc3b90e19daf9">PartitionerMetadata::get_metadata</a>(engine_, storage_id_);</div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(metadata-&gt;valid_);</div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;  MasstreePartitionerData* data</div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;    = <span class="keyword">reinterpret_cast&lt;</span>MasstreePartitionerData*<span class="keyword">&gt;</span>(metadata-&gt;locate_data(engine_));</div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(data-&gt;partition_count_ &gt; 0);</div>
<div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;  <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(data-&gt;partition_count_ &lt; <a class="code" href="group__MASSTREE.html#ga6b0f46dbd051897bd6dae9bbd3eb446e">kMaxIntermediatePointers</a>);</div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;  uint16_t cur = 0;</div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;  <span class="keywordflow">for</span> (MasstreeIntermediatePointerIterator it(volatile_page); it.is_valid(); it.next()) {</div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;    DualPagePointer* pointer = &amp;volatile_page-&gt;get_minipage(it.index_).pointers_[it.index_mini_];</div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;    <span class="keywordflow">if</span> (!args.partitioned_drop_) {</div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;      result.combine(drop_volatiles_recurse(args, pointer));</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;      <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;    }</div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;    <span class="comment">// the page boundaries as of partitioning might be different from the volatile page&#39;s,</span></div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;    <span class="comment">// but at least it&#39;s more coarse. Each pointer belongs to just one partition.</span></div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;    <span class="comment">// same trick as install_pointers.</span></div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;    <a class="code" href="group__MASSTREE.html#ga556e8f0d5e02e78f3ddecd8f5b022bf6">KeySlice</a> low = it.get_low_key();</div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;    <a class="code" href="group__MASSTREE.html#ga556e8f0d5e02e78f3ddecd8f5b022bf6">KeySlice</a> high = it.get_high_key();</div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;      <a class="code" href="group__MASSTREE.html#ga556e8f0d5e02e78f3ddecd8f5b022bf6">KeySlice</a> partition_high;</div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;      <span class="keywordflow">if</span> (cur + 1U == data-&gt;partition_count_) {</div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;        partition_high = <a class="code" href="namespacefoedus_1_1storage_1_1masstree.html#a7bfcd277a96bcd1e9008459abe1ec40d">kSupremumSlice</a>;</div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;      } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;        partition_high = data-&gt;low_keys_[cur + 1U];</div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;      }</div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;      <span class="keywordflow">if</span> (high &lt;= partition_high) {</div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;      }</div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;      ++cur;</div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;    }</div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;    <a class="code" href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a>(cur &lt; data-&gt;partition_count_);</div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;    <span class="keywordflow">if</span> (data-&gt;partitions_[cur] == args.my_partition_) {</div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;      <span class="keywordflow">if</span> (data-&gt;low_keys_[cur] != low) {</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;        VLOG(0) &lt;&lt; <span class="stringliteral">&quot;Not exactly matching page boundary.&quot;</span>;  <span class="comment">// but not a big issue.</span></div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;      }</div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;      result.combine(drop_volatiles_recurse(args, pointer));</div>
<div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;    }</div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;  }</div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;</div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;  <span class="comment">// we so far always keep the volatile root of a masstree storage.</span></div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;  <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;}</div>
<div class="ttc" id="structfoedus_1_1storage_1_1Metadata_html_a675df0db1a3c909581db949c10fd192b"><div class="ttname"><a href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b">foedus::storage::Metadata::keeps_all_volatile_pages</a></div><div class="ttdeci">bool keeps_all_volatile_pages() const </div><div class="ttdef"><b>Definition:</b> <a href="metadata_8hpp_source.html#l00098">metadata.hpp:98</a></div></div>
<div class="ttc" id="group__MASSTREE_html_ga556e8f0d5e02e78f3ddecd8f5b022bf6"><div class="ttname"><a href="group__MASSTREE.html#ga556e8f0d5e02e78f3ddecd8f5b022bf6">foedus::storage::masstree::KeySlice</a></div><div class="ttdeci">uint64_t KeySlice</div><div class="ttdoc">Each key slice is an 8-byte integer. </div><div class="ttdef"><b>Definition:</b> <a href="masstree__id_8hpp_source.html#l00126">masstree_id.hpp:126</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1Storage_html_ac1b54d4e7f3ad9f7f7c17598911abb01"><div class="ttname"><a href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01">foedus::storage::Storage::get_name</a></div><div class="ttdeci">const StorageName &amp; get_name() const </div><div class="ttdoc">Returns the unique name of this storage. </div><div class="ttdef"><b>Definition:</b> <a href="storage_8hpp_source.html#l00155">storage.hpp:155</a></div></div>
<div class="ttc" id="group__MASSTREE_html_ga6b0f46dbd051897bd6dae9bbd3eb446e"><div class="ttname"><a href="group__MASSTREE.html#ga6b0f46dbd051897bd6dae9bbd3eb446e">foedus::storage::masstree::kMaxIntermediatePointers</a></div><div class="ttdeci">const uint32_t kMaxIntermediatePointers</div><div class="ttdoc">Max number of pointers (if completely filled) stored in an intermediate pages. </div><div class="ttdef"><b>Definition:</b> <a href="masstree__page__impl_8hpp_source.html#l00251">masstree_page_impl.hpp:251</a></div></div>
<div class="ttc" id="namespacefoedus_1_1storage_1_1masstree_html_a7bfcd277a96bcd1e9008459abe1ec40d"><div class="ttname"><a href="namespacefoedus_1_1storage_1_1masstree.html#a7bfcd277a96bcd1e9008459abe1ec40d">foedus::storage::masstree::kSupremumSlice</a></div><div class="ttdeci">const KeySlice kSupremumSlice</div><div class="ttdef"><b>Definition:</b> <a href="masstree__id_8hpp_source.html#l00137">masstree_id.hpp:137</a></div></div>
<div class="ttc" id="group__IDIOMS_html_gaa5c1d074da423c0f330d1bc8a098ecb8"><div class="ttname"><a href="group__IDIOMS.html#gaa5c1d074da423c0f330d1bc8a098ecb8">ASSERT_ND</a></div><div class="ttdeci">#define ASSERT_ND(x)</div><div class="ttdoc">A warning-free wrapper macro of assert() that has no performance effect in release mode even when &#39;x&#39;...</div><div class="ttdef"><b>Definition:</b> <a href="assert__nd_8hpp_source.html#l00072">assert_nd.hpp:72</a></div></div>
<div class="ttc" id="classfoedus_1_1Attachable_html_a5b324e3abf302a59801aa73419bb4fad"><div class="ttname"><a href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad">foedus::Attachable::get_control_block</a></div><div class="ttdeci">CONTROL_BLOCK * get_control_block() const </div><div class="ttdef"><b>Definition:</b> <a href="attachable_8hpp_source.html#l00097">attachable.hpp:97</a></div></div>
<div class="ttc" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeStorage_html_a94bc2a1ae36c0a1ce1de99715072c59d"><div class="ttname"><a href="classfoedus_1_1storage_1_1masstree_1_1MasstreeStorage.html#a94bc2a1ae36c0a1ce1de99715072c59d">foedus::storage::masstree::MasstreeStorage::get_masstree_metadata</a></div><div class="ttdeci">const MasstreeMetadata * get_masstree_metadata() const </div><div class="ttdef"><b>Definition:</b> <a href="masstree__storage_8cpp_source.html#l00059">masstree_storage.cpp:59</a></div></div>
<div class="ttc" id="structfoedus_1_1storage_1_1PartitionerMetadata_html_aa6e48ddb92bb1c1b572cc3b90e19daf9"><div class="ttname"><a href="structfoedus_1_1storage_1_1PartitionerMetadata.html#aa6e48ddb92bb1c1b572cc3b90e19daf9">foedus::storage::PartitionerMetadata::get_metadata</a></div><div class="ttdeci">static PartitionerMetadata * get_metadata(Engine *engine, StorageId id)</div><div class="ttdoc">Returns the shared memory for the given storage ID. </div><div class="ttdef"><b>Definition:</b> <a href="partitioner_8cpp_source.html#l00038">partitioner.cpp:38</a></div></div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ad25781d742feeced13ed8b047b485a3e_cgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ad25781d742feeced13ed8b047b485a3e_cgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ad25781d742feeced13ed8b047b485a3e_cgraph" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ad25781d742feeced13ed8b047b485a3e_cgraph">
<area shape="rect" id="node2" href="structfoedus_1_1storage_1_1Composer_1_1DropResult.html#a0cac5a92e42765bafd1fd54ca3200080" title="foedus::storage::Composer\l::DropResult::combine" alt="" coords="258,5,437,47"/>
<area shape="rect" id="node5" href="classfoedus_1_1Attachable.html#a5b324e3abf302a59801aa73419bb4fad" title="foedus::Attachable\l::get_control_block" alt="" coords="281,71,413,112"/>
<area shape="rect" id="node6" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeStorage.html#a94bc2a1ae36c0a1ce1de99715072c59d" title="foedus::storage::masstree\l::MasstreeStorage::get\l_masstree_metadata" alt="" coords="261,137,434,193"/>
<area shape="rect" id="node7" href="structfoedus_1_1storage_1_1PartitionerMetadata.html#aa6e48ddb92bb1c1b572cc3b90e19daf9" title="Returns the shared memory for the given storage ID. " alt="" coords="258,217,437,259"/>
<area shape="rect" id="node11" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeIntermediatePage.html#a1cb83de15afc0a903046937276b0ed31" title="foedus::storage::masstree\l::MasstreeIntermediatePage\l::get_minipage" alt="" coords="524,407,709,463"/>
<area shape="rect" id="node12" href="classfoedus_1_1storage_1_1Storage.html#ac1b54d4e7f3ad9f7f7c17598911abb01" title="Returns the unique name of this storage. " alt="" coords="265,480,429,521"/>
<area shape="rect" id="node13" href="structfoedus_1_1storage_1_1masstree_1_1MasstreeIntermediatePointerIterator.html#acd0b166a127ed5fbadecd838f8e32be5" title="foedus::storage::masstree\l::MasstreeIntermediatePointerIterator\l::is_valid" alt="" coords="229,399,465,455"/>
<area shape="rect" id="node15" href="structfoedus_1_1storage_1_1Metadata.html#a675df0db1a3c909581db949c10fd192b" title="foedus::storage::Metadata\l::keeps_all_volatile_pages" alt="" coords="261,545,434,587"/>
<area shape="rect" id="node16" href="structfoedus_1_1storage_1_1PartitionerMetadata.html#a0534520d3f4fb059afdf7b9db375907e" title="Returns the partitioner data pointed from this metadata. " alt="" coords="258,283,437,324"/>
<area shape="rect" id="node3" href="classfoedus_1_1Epoch.html#adf886b8b219538b7dac2da820fbec68c" title="Kind of std::max(this, other). " alt="" coords="529,13,704,39"/>
<area shape="rect" id="node4" href="classfoedus_1_1Epoch.html#a8228a1a49b7db9b93498a778cb40f8e9" title="foedus::Epoch::is_valid" alt="" coords="768,13,923,39"/>
<area shape="rect" id="node8" href="classfoedus_1_1soc_1_1SharedMemoryRepo.html#a1c21cc6a27cabaf4a8c9dc26985aacfb" title="foedus::soc::SharedMemory\lRepo::get_global_memory\l_anchors" alt="" coords="524,130,709,186"/>
<area shape="rect" id="node9" href="classfoedus_1_1soc_1_1SocManager.html#a627cf434892c441c90c2de7c20637e9c" title="Returns the shared memories maintained across SOCs. " alt="" coords="527,211,707,252"/>
<area shape="rect" id="node10" href="classfoedus_1_1Engine.html#ae9ad7ab6a3df52b0e9f0e50ede6faa2e" title="See SOC and IPC. " alt="" coords="549,276,684,317"/>
<area shape="rect" id="node14" href="classfoedus_1_1storage_1_1masstree_1_1MasstreePage.html#a3ab3ec4aa9b6e43a606e1555c5c74cec" title="physical key count (those keys might be deleted) in this page. " alt="" coords="513,488,720,529"/>
<area shape="rect" id="node17" href="classfoedus_1_1Engine.html#a6546930099132529543c320327367ef1" title="foedus::Engine::get\l_options" alt="" coords="549,341,684,383"/>
</map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ad25781d742feeced13ed8b047b485a3e_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ad25781d742feeced13ed8b047b485a3e_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ad25781d742feeced13ed8b047b485a3e_icgraph" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ad25781d742feeced13ed8b047b485a3e_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1Composer.html#a0995635b97031b208127004382947acd" title="Drops volatile pages that have not been modified since the snapshotted epoch. " alt="" coords="229,39,408,80"/>
<area shape="rect" id="node3" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a26c51902174b692c91aedd15218f01b7" title="subroutine invoked by one thread for one node. " alt="" coords="456,31,640,87"/>
<area shape="rect" id="node4" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a5d474e7a6b4de127153103f2295cb0fa" title="Sub&#45;routine of handle_snapshot_triggered(). " alt="" coords="688,39,915,80"/>
<area shape="rect" id="node5" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a905ccf76fe0e076980dc1965f038fe10" title="handle_snapshot() calls this when it should start snapshotting. " alt="" coords="963,31,1173,87"/>
<area shape="rect" id="node6" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a64e3c7594b7d7d0d5f8a144bd802d910" title="Main routine for snapshot_thread_ in master engine. " alt="" coords="1221,5,1432,47"/>
<area shape="rect" id="node8" href="classfoedus_1_1restart_1_1RestartManagerPimpl.html#a8c5418a3e6d3558aa3920a605834df08" title="Recover the state of database from recent snapshot files and transaction logs. " alt="" coords="1249,71,1404,112"/>
<area shape="rect" id="node7" href="classfoedus_1_1snapshot_1_1SnapshotManagerPimpl.html#a632a4da7b3c67dd687f7eba4f6ec1d76" title="foedus::snapshot::Snapshot\lManagerPimpl::initialize_once" alt="" coords="1480,5,1675,47"/>
<area shape="rect" id="node9" href="classfoedus_1_1restart_1_1RestartManagerPimpl.html#a868dca9015af77e04202ead68fd7a136" title="foedus::restart::Restart\lManagerPimpl::initialize_once" alt="" coords="1480,71,1675,112"/>
</map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab1264661a1f24383dcda1568f59425fe"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::string foedus::storage::masstree::MasstreeComposer::to_string </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="masstree__composer__impl_8cpp_source.html#l00282">282</a> of file <a class="el" href="masstree__composer__impl_8cpp_source.html">masstree_composer_impl.cpp</a>.</p>

<p>Referenced by <a class="el" href="masstree__composer__impl_8cpp_source.html#l00078">compose()</a>, and <a class="el" href="masstree__composer__impl_8cpp_source.html#l00111">construct_root()</a>.</p>
<div class="fragment"><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                                            {</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;  <span class="keywordflow">return</span> std::string(<span class="stringliteral">&quot;MasstreeComposer-&quot;</span>) + std::to_string(storage_id_);</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;}</div>
</div><!-- fragment -->
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ab1264661a1f24383dcda1568f59425fe_icgraph.png" border="0" usemap="#classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ab1264661a1f24383dcda1568f59425fe_icgraph" alt=""/></div>
<map name="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ab1264661a1f24383dcda1568f59425fe_icgraph" id="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer_ab1264661a1f24383dcda1568f59425fe_icgraph">
<area shape="rect" id="node2" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#a05590cc1eeeb3aedd917276d19639fd1" title="foedus::storage::masstree\l::MasstreeComposer::compose" alt="" coords="270,5,474,47"/>
<area shape="rect" id="node4" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html#a45eb1cba6ccf8f51c973030848a47a9d" title="foedus::storage::masstree\l::MasstreeComposer::construct_root" alt="" coords="255,71,489,112"/>
<area shape="rect" id="node3" href="classfoedus_1_1storage_1_1Composer.html#a28c752ec784b85418c0bfafab7ee60c0" title="Construct snapshot pages from sorted run files of one storage. " alt="" coords="537,5,716,47"/>
<area shape="rect" id="node5" href="classfoedus_1_1storage_1_1Composer.html#adf148cbea7c8146dec88d23d2218452c" title="Construct root page(s) for one storage based on the ouputs of compose(). " alt="" coords="537,71,716,112"/>
</map>
</div>
</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>/home/shino/foedus_code/foedus-core/include/foedus/storage/masstree/<a class="el" href="masstree__composer__impl_8hpp_source.html">masstree_composer_impl.hpp</a></li>
<li>/home/shino/foedus_code/foedus-core/src/foedus/storage/masstree/<a class="el" href="masstree__composer__impl_8cpp_source.html">masstree_composer_impl.cpp</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacefoedus.html">foedus</a></li><li class="navelem"><a class="el" href="namespacefoedus_1_1storage.html">storage</a></li><li class="navelem"><a class="el" href="namespacefoedus_1_1storage_1_1masstree.html">masstree</a></li><li class="navelem"><a class="el" href="classfoedus_1_1storage_1_1masstree_1_1MasstreeComposer.html">MasstreeComposer</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
