<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>libfoedus-core: Memorandum on ARMv8 (AArch64) Support</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libfoedus-core
   </div>
   <div id="projectbrief">FOEDUS Core Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/centos7/"><span>Jenkins&#160;(x86_64&#160;Fedora)</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/ub1404/"><span>Jenkins&#160;(x86_64&#160;Ubuntu)</span></a></li>
      <li><a href="http://ms01915-003.hpl.hp.com:8080/"><span>Jenkins&#160;(aarch64&#160;Ubuntu)</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/tree/master"><span>Github</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/wiki"><span>Wiki</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__ARMV8.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Memorandum on ARMv8 (AArch64) Support<div class="ingroups"><a class="el" href="group__IDIOMS.html">FOEDUS Programming Idioms</a> &raquo; <a class="el" href="group__COMPILER.html">Compiler Specific Optimizations</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>We keep notes on FOEDUS's ARMv8 (AArch64) Support here.  
<a href="#details">More...</a></p>
<p>We keep notes on FOEDUS's ARMv8 (AArch64) Support here. </p>
<p>This file is not a source code. It's just a collection of notes on what we did and what we have to keep in mind regarding ARMv8 support. It's an emerging environment where some information that was correct quickly become obsolete. So, also leave the date you wrote each section.</p>
<dl class="section user"><dt>Target compiler is GCC/clang</dt><dd>We assume gcc/clang. No ICC. We initially assumed gcc only, but we plesantly found that clang has a quite good gcc-compatibility. So, we got FOEDUS work on clang without much hassle. We aggressively use gcc's builtin methods to abstract x86-aarch64 differences as far as they are supported in clang, and most of them are!</dd></dl>
<p>Sorry, ICC, you seem to be a red-headed stepchild.</p>
<dl class="section user"><dt>aarch64 and AARCH64EB/__AARCH64EL__ macro</dt><dd>This macro is defined if gcc is running on AArch64 (latter two for big/little endian, but I bet you are getting <b>AARCH64EL</b>. see "gcc -dM -E - &lt; /dev/null "). Use it like: <div class="fragment"><div class="line"><span class="preprocessor">#if defined(__aarch64__)</span></div>
<div class="line">...</div>
<div class="line">#<span class="keywordflow">if</span> undefined(__aarch64__)</div>
<div class="line">...</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>128-bit atomic CAS</dt><dd>[Dec14] So many gotcha's about this. First, gcc on x86 allows users to specify "-mcx16" to enable __sync_bool_compare_and_swap on __uint128_t, __atomic_compare_exchange_16, etc. ARMv8 does support 128-bit atomic operations such as ldaxp/stlxp, but gcc-AArch64 doesn't support -mcx16. We initially thought this means we can't do cas128 without resorting to assembly. However, it turns out that gcc-AArch64 does allow __atomic_compare_exchange_16 if one links to <b>libatomic.so</b>, which is a shared library that is a part of newer gcc. This library is provided in gcc-AArch64. See our CMakeLists.txt and FindGccAtomic.cmake for more details. We keep using the old way (-mcx16 without libatomic.so) in x86 because that would be just a waste (one shared-library call overhead) on x86.</dd></dl>
<dl class="section user"><dt>Atomic CAS on ARMV8.1</dt><dd>[Dec14] There is an additional information on this subject. Currently, ARMv8 doesn't have a specific instruction for CAS (like x86's cmpxchg). You lock the cacheline with ldax, then store with stlx. Some one says that this might be different in ARMv8.1, adding cmpxchg for better performance. It makes sense and might be much faster. We hope gcc would automatically make use of it.</dd></dl>
<dl class="section user"><dt>[...]mintrin.h, such as xmmintrin.h</dt><dd>[Dec14] In one sentence, it's not there. /usr/lib/gcc/aarch64-linux-gnu/4.8.2/include contains a surprisingly lower number of files than /usr/lib/gcc/x86_64-redhat-linux/4.8.3/include/, and all mintrin.h are gone. We must not depend on them, or use ifdef for AArch64. It makes sense because these files are mainly for x86's SSE. But it did contain many other things such as mm_pause and mm_prefetch.</dd></dl>
<dl class="section user"><dt>Cacheline prefetch</dt><dd>[Dec14] Because xmmintrin.h is not available, we use gcc's __builtin_prefetch on ARMv8 instead of mm_prefetch, discarding compiler-portability for the sake of OS-portability. how damn. __builtin_prefetch also allows users to specify r or rw, but as far as I understand no implementation actually makes use of this hint so far.</dd></dl>
<dl class="section user"><dt>RDTSC-equivalent</dt><dd>[Dec14] <a class="el" href="rdtsc_8hpp.html" title="Implements an RDTSC (Real-time time stamp counter) wait to emulate latency on slower devices...">foedus/debugging/rdtsc.hpp</a> uses x86's rdtsc as a low-overhead high-precision counter. The equivalent on ARMv8 is cntvct_el0, which can be used in user mode unlike earlier ARM ISA. </dd></dl>
<div class="dynheader">
Collaboration diagram for Memorandum on ARMv8 (AArch64) Support:</div>
<div class="dyncontent">
<center><table><tr><td><img src="group__ARMV8.png" border="0" alt="" usemap="#group____ARMV8"/>
<map name="group____ARMV8" id="group____ARMV8">
<area shape="rect" id="node1" href="group__COMPILER.html" title="A few macros and functions to exploit compiler specific optimizations. " alt="" coords="5,13,212,39"/>
</map>
</td></tr></table></center>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
