<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>libfoedus-core: Initialize/Uninitialize Resources</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libfoedus-core
   </div>
   <div id="projectbrief">FOEDUS Core Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/centos7/"><span>Jenkins&#160;(x86_64&#160;Fedora)</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/ub1404/"><span>Jenkins&#160;(x86_64&#160;Ubuntu)</span></a></li>
      <li><a href="http://ms01915-003.hpl.hp.com:8080/"><span>Jenkins&#160;(aarch64&#160;Ubuntu)</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/tree/master"><span>Github</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/wiki"><span>Wiki</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__INITIALIZABLE.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a>  </div>
  <div class="headertitle">
<div class="title">Initialize/Uninitialize Resources<div class="ingroups"><a class="el" href="group__IDIOMS.html">FOEDUS Programming Idioms</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Defines a uniform class interface to initialize/uninitialize non-trivial resources.  
<a href="#details">More...</a></p>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Defines a uniform class interface to initialize/uninitialize non-trivial resources. </p>
<dl class="section user"><dt>Constructor/Destructor vs initialize()/uninitialize()</dt><dd>Constructor should not do complicated initialization as it can't return errors. Instead, we universally use initialize()/uninitialize() semantics for all long-living objects. By long-living, we mean at least seconds. Small and short-living objects do not have to follow this semantics as it might cause unnecessary complexity or overhead.</dd></dl>
<p>Same applies to Destructor vs uninitialize(). Furthermore, C++ doesn't allow calling virtual functions (uninitialize()) in destructor as the class information was already torn down! So, make sure you always explicitly call uninitialize(). If you didn't call uninitialize(), you actually leak the resource.</p>
<dl class="section user"><dt>DefaultInitializable</dt><dd>For most classes, you can use <a class="el" href="classfoedus_1_1DefaultInitializable.html" title="Typical implementation of Initializable as a skeleton base class. ">DefaultInitializable</a> class to save repetitive code. For example, declare your class like the following: <div class="fragment"><div class="line"><span class="keyword">class </span>YourClass : <span class="keyword">public</span> DefaultInitializable {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">    YourClass(<span class="keyword">const</span> ConfigurationForYourClass &amp;conf, <span class="keywordtype">int</span> other_params, ...);</div>
<div class="line">    ...</div>
<div class="line">    ErrorStack  initialize_once() <a class="code" href="group__CXX11.html#ga227e03075b55f272574b1ce9ae454450">CXX11_OVERRIDE</a>;</div>
<div class="line">    ErrorStack  uninitialize_once() <a class="code" href="group__CXX11.html#ga227e03075b55f272574b1ce9ae454450">CXX11_OVERRIDE</a>;</div>
<div class="line">};</div>
</div><!-- fragment --> Then, define initialize_once()/uninitialize_once() as follows in cpp. <div class="fragment"><div class="line">ErrorStack  YourClass::initialize_once() {</div>
<div class="line">   .... <span class="comment">// one-time initialization for this object</span></div>
<div class="line">   <span class="keywordflow">return</span> <a class="code" href="group__ERRORCODES.html#ga61f52cd33eb500d6997a91e704ace244">kRetOk</a>;</div>
<div class="line">}</div>
<div class="line">ErrorStack  YourClass::uninitialize_once() {</div>
<div class="line">   <span class="comment">// one-time uninitialization for this object. continue releasing resources even when</span></div>
<div class="line">   <span class="comment">// there is some error. So, use ErrorStackBatch to wrap more than one errors.</span></div>
<div class="line">   ErrorStackBatch batch;</div>
<div class="line">   batch.emplace_back(some_uninitialization());</div>
<div class="line">   batch.emplace_back(another_uninitialization());</div>
<div class="line">   batch.emplace_back(yet_another_uninitialization());</div>
<div class="line">   <span class="keywordflow">return</span> <a class="code" href="group__ERRORCODES.html#ga67390b22b0afbe5a4938df9847eafda9">SUMMARIZE_ERROR_BATCH</a>(batch);</div>
<div class="line">}</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>UninitializeGuard, or how RAII fails in real world.</dt><dd>The code that instantiates an <a class="el" href="classfoedus_1_1Initializable.html" title="The pure-virtual interface to initialize/uninitialize non-trivial resources. ">Initializable</a> object must call uninitialize() for the reasons above. Even if there is some error, which causes an early return from the function by <a class="el" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4" title="This macro calls x and checks its returned value. ">CHECK_ERROR()</a> in many cases. Note that try-catch(...) does not work because this is NOT an exception (and we never use exceptions in our code). <em>YOU</em> have to make sure uninitialize() is called. <a class="el" href="classfoedus_1_1UninitializeGuard.html" title="Calls Initializable::uninitialize() automatically when it gets out of scope. ">UninitializeGuard</a> addresses this issue, <b>but</b> <b>imperfectly</b>. For example, use it like this: <div class="fragment"><div class="line">ErrorStack your_func() {</div>
<div class="line">    YourInitializable object;</div>
<div class="line">    <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(<span class="keywordtype">object</span>.initialize());</div>
<div class="line">    {</div>
<div class="line">        UninitializeGuard guard(&amp;<span class="keywordtype">object</span>, <a class="code" href="classfoedus_1_1UninitializeGuard.html#ae6caa12ca9b75a22b53c2eed31402721af0067551d00455a2a16416216de53568">UninitializeGuard::kWarnIfUninitializeError</a>);</div>
<div class="line">        <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(<span class="keywordtype">object</span>.do_something());</div>
<div class="line">        <a class="code" href="group__ERRORCODES.html#ga72a80915c3588aea09c053ab567e19c4">CHECK_ERROR</a>(<span class="keywordtype">object</span>.uninitialize());</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> The <a class="el" href="classfoedus_1_1UninitializeGuard.html" title="Calls Initializable::uninitialize() automatically when it gets out of scope. ">UninitializeGuard</a> object automatically calls object.uninitialize() when do_something() fails and we return from your_func(). <b>HOWEVER</b>, C++'s destructor can't propagate any errors, in our case <a class="el" href="classfoedus_1_1ErrorStack.html" title="Brings error stacktrace information as return value of functions. ">ErrorStack</a>. The second argument (<a class="el" href="classfoedus_1_1UninitializeGuard.html#ae6caa12ca9b75a22b53c2eed31402721af0067551d00455a2a16416216de53568" title="Automatically calls if uninitialize() wasn&#39;t called when it gets out of scope, and just complains whe...">UninitializeGuard::kWarnIfUninitializeError</a>) says that if it encounters an error while uninitialize() call, it just warns it in debug log. Logging the error is not a perfect solution at all. So, this is just an imperfect safety net. Unfortunately, this is all what we can do in C++ for objects that have non-trivial release. </dd></dl>
<div class="dynheader">
Collaboration diagram for Initialize/Uninitialize Resources:</div>
<div class="dyncontent">
<center><table><tr><td><img src="group__INITIALIZABLE.png" border="0" alt="" usemap="#group____INITIALIZABLE"/>
<map name="group____INITIALIZABLE" id="group____INITIALIZABLE">
<area shape="rect" id="node2" href="group__IDIOMS.html" title="You must first get used to these things to use/develop libfoedus. " alt="" coords="5,5,163,47"/>
</map>
</td></tr></table></center>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1Initializable.html">foedus::Initializable</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">The pure-virtual interface to initialize/uninitialize non-trivial resources.  <a href="classfoedus_1_1Initializable.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1DefaultInitializable.html">foedus::DefaultInitializable</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Typical implementation of <a class="el" href="classfoedus_1_1Initializable.html" title="The pure-virtual interface to initialize/uninitialize non-trivial resources. ">Initializable</a> as a skeleton base class.  <a href="classfoedus_1_1DefaultInitializable.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classfoedus_1_1UninitializeGuard.html">foedus::UninitializeGuard</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calls <a class="el" href="classfoedus_1_1Initializable.html#afbe5738b0bc85362fba80bdf788fd3c3" title="An idempotent method to release all resources of this object, if any. ">Initializable::uninitialize()</a> automatically when it gets out of scope.  <a href="classfoedus_1_1UninitializeGuard.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
