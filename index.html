<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>libfoedus-core: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libfoedus-core
   </div>
   <div id="projectbrief">FOEDUS Core Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/centos7/"><span>Jenkins&#160;(x86_64&#160;Fedora)</span></a></li>
      <li><a href="http://cihead.labs.hpe.com/ub1404/"><span>Jenkins&#160;(x86_64&#160;Ubuntu)</span></a></li>
      <li><a href="http://ms01915-003.hpl.hp.com:8080/"><span>Jenkins&#160;(aarch64&#160;Ubuntu)</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/tree/master"><span>Github</span></a></li>
      <li><a href="http://github.com/hkimura/foedus_code/wiki"><span>Wiki</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">libfoedus-core Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Introduction </h2>
<p>This project is the gut of FOEDUS as a transactional key-value storage system. Your client program can use this library by containing the CMakeLists.txt or linking to the shared library.</p>
<p>For more introductory stuffs, visit <a href="https://github.com/hkimura/foedus">our github site</a>. and/or take a look at the <a href="http://www.hpl.hp.com/techreports/2015/HPL-2015-37.html">overview paper</a>.</p>
<h2>Hardware/Compiler/OS Requirements </h2>
<ul>
<li>We support only 64-bits CPUs. More specifically, x86_64 and ARMv8.</li>
<li>We assume Linux/Unix so far. No MacOS, Windows, nor Solaris.</li>
<li>We strongly recommend linux kernel 3.16 or later. [^1]</li>
<li>We assume fsync(2) penetrates all the way through the device. [^2]</li>
<li>We require reasonably modern C++ compilers, namely gcc 4.8.2 or later. [^3]</li>
<li>We depend on CMake and several other toolsets/libraries. But, we guarantee that all of them are commonly available from default package repositories. Otherwise, we include the dependency in our code.</li>
</ul>
<p>[^1]: In older linux kernel, page-fault of hugepages was almost single-threaded (!!!). This issue was fixed in 3.15 along with many other scalability improvements contributed by HP's linux developers.</p>
<p>[^2]: If this is not the case, check your write-cache settings in the filesystem and device driver. Unfortunately, even if users configure it right, some storage device sacrifices durability for the sake of performance. So is some file system. For those environments, we cannot guarantee ACID.</p>
<p>[^3]: [2015 Jul] We have added an <em>experimental</em> support for clang.</p>
<h2>Verified Environments </h2>
<p>The Linux kernel, distros, compilers, and libraries are quickly moving forward. Which is great, but we often see breaking issues due to version differences. If you want to minimize unexpected bumps, we recommend to use one of the following <b>verified environments</b> where we continuously test our code on Jenkins services.</p>
<ul>
<li>(Primary) Centos 7.2, x86_64. <a href="http://cihead.labs.hpe.com/centos7/">Our Jenkins Server</a>.</li>
<li>Ubuntu 14.04, x86_64. <a href="http://cihead.labs.hpe.com/ub1404/">Our Jenkins Server</a>.</li>
<li>Ubuntu 14.04, aarch64. <a href="http://ms01915-003.hpl.hp.com:8080/">Our Jenkins Server</a>.</li>
</ul>
<p>We will occasionally switch to semi-latest versions of Fedora (or some Redhat-flavor) and Ubuntu (or some Debian-flavor). In other words, we do not have enough resource to support versions that are several years old or less-popular distros.</p>
<h2>Environment Setup (ATTENTION! Read this before using FOEDUS!) </h2>
<p>Unfortunately, there are a few things you have to setup in your environment. These setups require sudo permission, so FOEDUS does not set them up itself. If you get any error, make sure you setup the followings.</p>
<ul>
<li>Allocate enough hugepages.</li>
</ul>
<p>FOEDUS uses non-transparent hugepages for most memory allocations. If the machine does not have enough hugepages, it will not even start up. Check your current configuration as follows. </p><pre class="fragment"># Check your current Hugepage setting
more /proc/sys/vm/nr_hugepages
more /proc/meminfo
</pre><p>Depending on the size of volatile pool and logger buffer you specify in the configuration, adjust the number of hugepages as follows. </p><pre class="fragment"># Change the number depending on hugepage size and required memory size.
# The following command allocates 2GB if Hugepagesize is 2048 kB.
sudo sh -c 'echo 1000 &gt; /proc/sys/vm/nr_hugepages'
# 1000 is a minimal number. It's just for running testcases. Increase the number according to your configuration.
</pre><p><b>CAUTION: PLEASE REMEMBER! THE ABOVE NUMBER IS TO JUST PASS TESTCASES. YOU MUST ALLOCATE MANY MORE HUGEPAGES DEPENDING ON YOUR CONFIGURATION.</b></p>
<p>Note that we no longer rely on transparent hugepages (THP), every hugepage allocation is via mmap and shmget. Thus, the user has to explicitly pre-allocate hugepages as above. We made this decision for a few reasons. First, a rumor says future linux will purge THP. Second, there are several performance issues in THP, including lack of 1GB hugepages and compaction. Third, many other large-scale software uses non-transparent hugepages. Mixing THP and non-transparent hugepages is known to have several issues, so we do not use THP to be a good citizen. Hence, we now recommend to disable THP.</p>
<ul>
<li>Increase maximum shared memory size.</li>
</ul>
<p>The default maximum of shared memory is ridiculously small. We recommend to set an infinitely large number as follows: </p><pre class="fragment">sudo sysctl -w kernel.shmmax=9223372036854775807
sudo sysctl -w kernel.shmall=1152921504606846720
sudo sysctl -w kernel.shmmni=409600
sudo sysctl -w vm.max_map_count=2147483647
sudo sysctl -p
</pre><p>The above command is effective only until reboot. In order to make it permanent, add the following entries to /etc/sysctl.conf: </p><pre class="fragment"># Add these entries to /etc/sysctl.conf.
kernel.shmmax = 9223372036854775807
kernel.shmall = 1152921504606846720
kernel.shmmni = 409600
vm.max_map_count = 2147483647
</pre><p>If you have some reason to set a smaller number, carefully calculate required sizes and replace the above numbers.</p>
<ul>
<li>Configure ulimit</li>
</ul>
<p>There are a few ulimit settings you have to increase. Some of these settings has a ridiculously small default value, so FOEDUS will not start up otherwise. </p><pre class="fragment"># Check your current ulimit setting
ulimit -a

# Add these entries to /etc/security/limits.conf.
&lt;your_user_name&gt;  - nofile 655360
&lt;your_user_name&gt;  - nproc 655360
&lt;your_user_name&gt;  - rtprio 99
&lt;your_user_name&gt;  - memlock -1
</pre><p>This will not take effect until you log-in again. If you want to immediately apply the values without log out, one workaround is: </p><pre class="fragment"># Note, even this does not work for already-running sessions/GUIs. re-login to make sure.
sudo -i -u &lt;your_user_name&gt;
</pre><ul>
<li>Configure hugetlb_shm_group</li>
</ul>
<p>We are not sure when this one is needed, but we did observe shmget failures in some environment, namely Ubuntu. On Fedora, we never failed a hugepage allocation via shmget even without configuring this parameter. </p><pre class="fragment"># Create a user group, say hugeshm, then add yourself to the group
sudo su
groupadd hugeshm
usermod -a -G hugeshm &lt;your_account&gt;
id &lt;your_account&gt; # this tells the group ID

# then write the group ID to /proc/sys/vm/hugetlb_shm_group. To make this
# configuration permanent, add "vm.hugetlb_shm_group" entry in sysctl.conf.
echo &lt;Group ID&gt; &gt; /proc/sys/vm/hugetlb_shm_group
</pre><p>Finally, <b>we strongly recommend rebooting</b> the machine after configuring all of the above. sysctl -p is supposed to be enough, but do make sure by rebooting.</p>
<ul>
<li>Error messages you will see</li>
</ul>
<p>If the above configurations are not effective, you will get kErrorCodeSocShmAllocFailed error. Our ErrorStack object often contains additional details of the cause, for example: </p><pre class="fragment">kErrorCodeSocShmAllocFailed(3073):SOC    : Failed to allocate a shared memory. This is usually
caused by a misconfigured environment. Check the following:
- Too small kernel.shmmax/kernel.shmmin. sudo sysctl -w kernel.shmmax=9223372036854775807;sudo sysctl -w kernel.shmall=1152921504606846720;sudo sysctl -w kernel.shmmni=409600;sudo sysctl -p
- Too few hugepages. sudo sh -c 'echo 1000 &gt; /proc/sys/vm/nr_hugepages'
- Too small mlock. Check ulimit -l. Configure /etc/security/limits.conf
- Too small nofile. Check ulimit -a. Configure /etc/security/limits.conf
- Simply larger than DRAM in the machine.
- (Very rare) shm key conflict.
(Latest system call error=[Errno 1] Operation not permitted)
(Additional message=shmget() failed! size=4194304, os_error=[Errno 1] Operation not permitted, ...
</pre><p>In the above example, "[Errno 1] Operation not permitted" strongly implies that there is a limits/permissions issue on hugepages and/or shared memory. Unfortunately, this is one of the nastiest configuration in linux.</p>
<ul>
<li>How to quickly check whether your environment is correctly setup.</li>
</ul>
<p><b>NOTE: ALWAYS PASS THIS STEP BEFORE MOVING ON</b> </p><pre class="fragment"># Assume you are in foedus_code, and you have already compiled FOEDUS.
cd build
ctest -R test_check_env -j4
</pre><p>If any of the tests fails, there is still something you missed. The above testcases only check minimal reasonable values. Depending on your data size, you might need way larger values.</p>
<h2>Compilation </h2>
<p>(If you get a compilation error for missing libraries, refer to Dependencies section.) Suppose you want to contain the CMakeLists.txt in your CMake project. Add the following lines in your CMakeLists.txt: </p><pre class="fragment">add_subdirectory(path_to_foedus-core ${CMAKE_CURRENT_BINARY_DIR}/foedus-core)
include_directories(path_to_foedus-core/include)
add_executable(your_program your_program_x.cpp your_program_y.cpp ...)
target_link_libraries(your_program foedus-core)
</pre><p>Compile your program to see if it is correctly linked to libfoedus-core.so.</p>
<p>Alternatively, you can install foedus-core into either your local directory or standard directories, such as /usr/lib /usr/lib64 etc. In that case, add the following lines in your CMakeLists.txt: </p><pre class="fragment"># Copy the FindFoedusCore.cmake file (placed under cmake) into your cmake folder beforehand:
set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_CURRENT_SOURCE_DIR}/cmake)
find_package(FoedusCore REQUIRED) # This sets FOEDUS_CORE_INCLUDE_DIR and FOEDUS_CORE_LIBRARIES
include_directories(${FOEDUS_CORE_INCLUDE_DIR})
add_executable(your_program your_program_x.cpp your_program_y.cpp ...)
target_link_libraries(your_program ${FOEDUS_CORE_LIBRARIES})
</pre><p>We recommend your program to turn on C++11, but not mandatory. You can link to and use libfoedus-core from C++98/03 projects without problems although some APIs are not exposed then. If you are to enable C++11, on the other hand, add the following in your CMakeLists. </p><pre class="fragment">set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11")
</pre><h2>Get Started </h2>
<p>Here is a minimal example program to create a key-value storage and query on it. <b>NOTE: Complete Environment Setup Beforehand!</b> <b>Did you pass "ctest -R test_check_env"?</b> </p><pre class="fragment">#include &lt;iostream&gt;

#include "foedus/engine.hpp"
#include "foedus/engine_options.hpp"
#include "foedus/epoch.hpp"
#include "foedus/proc/proc_manager.hpp"
#include "foedus/storage/storage_manager.hpp"
#include "foedus/storage/array/array_metadata.hpp"
#include "foedus/storage/array/array_storage.hpp"
#include "foedus/thread/thread.hpp"
#include "foedus/thread/thread_pool.hpp"
#include "foedus/xct/xct_manager.hpp"

const uint16_t kPayload = 16;
const uint32_t kRecords = 1 &lt;&lt; 20;
const char* kName = "myarray";
const char* kProc = "myproc";

foedus::ErrorStack my_proc(const foedus::proc::ProcArguments&amp; args) {
  foedus::Engine* engine = args.engine_;
  foedus::storage::array::ArrayStorage array(engine, kName);
  foedus::xct::XctManager* xct_manager = engine-&gt;get_xct_manager();
  WRAP_ERROR_CODE(xct_manager-&gt;begin_xct(context, foedus::xct::kSerializable));
  char buf[kPayload];
  WRAP_ERROR_CODE(array.get_record(context, 123, buf));
  foedus::Epoch commit_epoch;
  WRAP_ERROR_CODE(xct_manager-&gt;precommit_xct(context, &amp;commit_epoch));
  WRAP_ERROR_CODE(xct_manager-&gt;wait_for_commit(commit_epoch));
  return foedus::kRetOk;
}

int main(int argc, char argv) {
  foedus::EngineOptions options;
  foedus::Engine engine(options);
  engine.get_proc_manager()-&gt;pre_register(kProc, my_proc);
  COERCE_ERROR(engine.initialize());

  foedus::UninitializeGuard guard(&amp;engine);
  foedus::Epoch create_epoch;
  foedus::storage::array::ArrayMetadata meta(kName, kPayload, kRecords);
  COERCE_ERROR(engine.get_storage_manager()-&gt;create_storage(&amp;meta, &amp;create_epoch));
  foedus::ErrorStack result = engine.get_thread_pool()-&gt;impersonate_synchronous(kProc);
  std::cout &lt;&lt; "result=" &lt;&lt; result &lt;&lt; std::endl;
  COERCE_ERROR(engine.uninitialize());

  return 0;
}
</pre><h2>API Documents </h2>
<p>For more details, start from <a href="http://cihead.labs.hpe.com/centos7/job/foedus-master-doxygen/doxygen/">API document</a>.</p>
<h2>Dependencies </h2>
<p>We try hard to minimize library dependency so that at least libfoedus-core works in various environments. We statically link most of the libraries we internally use, thus they are not exposed as library dependency. The only exceptions are standard c++ library, libpthread and libnuma.</p>
<p>Standard C++ library is avaialble in most environments, so most likely you have already installed them. If not, run the following: </p><pre class="fragment">sudo yum install libstdc* # RedHat/Fedora
</pre><p>pthread is a fundamental library to execute multi-threaded programs. Note that you have to link to libpthread.so even if you use C++11. C++11 threading merely invokes libpthread, so you need to link to libpthread.so. Otherwise, libstdc will throw an error at <em>runtime</em> (ouch!) when our engine invokes it. Run the following: </p><pre class="fragment">sudo yum install glibc glibc-devel    # RedHat/Fedora
sudo apt-get install build-essential  # Debian/Ubuntu
</pre><p>Then, include the following in your CMakeLists.txt: </p><pre class="fragment">find_package(Threads REQUIRED)
target_link_libraries(your_program ${CMAKE_THREAD_LIBS_INIT})
</pre><p>Optimizing for NUMA architecture is also too essential to miss in our project. Thus, we link to libnuma. And, (to my knowledge) there is no good way to statically link to libnuma (libnuma is under LGPL). Hence, your client program must also link to libnuma.so. Run the following: </p><pre class="fragment">sudo yum install numactl numactl-devel  # RedHat/Fedora
sudo apt-get install libnuma-dev        # Debian/Ubuntu
</pre><p>Copy FindNuma.cmake in this cmake folder, then add the following in your CMakeLists.txt: </p><pre class="fragment">find_package(Numa REQUIRED)
target_link_libraries(your_program ${NUMA_LIBRARY})
</pre><p>Although not mandatory, libfoedus-core provides additional functionalities if there is google-perftools-devel. </p><pre class="fragment">sudo yum install google-perftools google-perftools-devel    # RedHat/Fedora
</pre><p>FOEDUS outputs a detailed backtrace to logs/traces if you have libdwarf installed. Whenever you report some bugs/crashes, we appreciate installing it to get informative stacktrace. </p><pre class="fragment">sudo yum install libdwarf libdwarf-devel    # RedHat/Fedora
sudo apt-get install libdwarf-dev           # Debian/Ubuntu
</pre><p>Another optional library is <a href="http://icl.cs.utk.edu/trac/papi/">PAPI</a>, with which FOEDUS can provide additional performance counters. </p><pre class="fragment">sudo yum install papi papi-devel papi-static    # RedHat/Fedora
</pre><p>We use none of boost libraries. We might consider using some of the header-only boost libraries, but we will surely stay away from non-header-only ones (eg filesystem).</p>
<p>One last optional package is tmpwatch to clean up /tmp where we output glog log files. </p><pre class="fragment">sudo yum install tmpwatch
sudo /usr/bin/tmpwatch -am 24 /tmp  # If you want, set this up as a cron job
</pre><h2>Licensing </h2>
<p>See <a href="LICENSE.txt">LICENSE.txt</a> for the license term of libfoedus-core itself.</p>
<p>In short, FOEDUS is open-sourced under <b>GPL</b> with <b>classpath exception that covers every file</b>. Yes, every file is exception though it might sound weird. This means you can link to libfoedus, either dynamically or statically, from an arbitrary program: GPL, Apache/BSD, or even proprietary program. However, if you modify FOEDUS itself, you need to provide your modification in a GPL-fashion. libstdc++ in gcc employs a similar license. We believe this style of GPL is more flexible/simple for users than LGPL.</p>
<p>We internally had intensive discussions on Apache/BSD vs GPL/LGPL, and this is our <em>final</em> decision. Almost no chance of later switching to Apache/BSD or other permissive licenses.</p>
<p>All manuals/documents (doxygen-generated HTMLs) are in Creative Commons.</p>
<p>libfoedus-core uses a few open source libraries listed below.</p>
<table class="doxtable">
<tr>
<th align="center">Library </th><th>License </th><th>Linking/Distribution in libfoedus-core  </th></tr>
<tr>
<td align="center">glog </td><td>BSD </td><td>Static-link. Contains source code. </td></tr>
<tr>
<td align="center"><a class="el" href="namespacetinyxml2.html">tinyxml2</a> </td><td>ZLIB </td><td>Static-link. Contains source code. </td></tr>
<tr>
<td align="center">libbacktrace </td><td>BSD </td><td>Static-link. Contains source code. </td></tr>
<tr>
<td align="center">gperftools </td><td>BSD </td><td>Optional dynamic-link. Distributes nothing. </td></tr>
<tr>
<td align="center">papi </td><td>BSD(?) </td><td>Optional dynamic-link. Distributes nothing. </td></tr>
<tr>
<td align="center">libnuma </td><td>LGPL </td><td>Dynamic-link. Distributes nothing. </td></tr>
<tr>
<td align="center">glibc/stdc++ </td><td>GPL+Exp </td><td>Dynamic-link. Distributes nothing. </td></tr>
<tr>
<td align="center">valgrind </td><td>BSD </td><td>Header-only. Contains valgrind.h only. </td></tr>
<tr>
<td align="center">xxHash </td><td>BSD </td><td>Static-link. Contains source code. </td></tr>
</table>
<p>For more details, see COPYING/LICENSE.txt/etc in the third-party folder. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
